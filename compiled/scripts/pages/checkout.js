define("modules/models-checkout",["modules/jquery-mozu","underscore","hyprlive","modules/backbone-mozu","modules/api","modules/models-customer","modules/models-address","modules/models-paymentmethods","hyprlivecontext"],function(e,t,i,n,a,r,o,s,d){var l=n.MozuModel.extend({helpers:["stepStatus","requiresFulfillmentInfo","isAwsCheckout","isNonMozuCheckout","requiresDigitalFulfillmentContact","isShippingEditHidden"],initStep:function(){var e=this;this.next=function(i){return t.debounce(function(){e.isLoading()||i.call(e)},750,!0)}(this.next);var i=e.getOrder();e.calculateStepStatus(),e.listenTo(i,"error",function(){e.isLoading()&&e.isLoading(!1)}),e.set("orderId",i.id),e.apiModel&&e.apiModel.on("action",function(t,n){n?n.orderId=i.id:e.apiModel.prop("orderId",i.id)})},calculateStepStatus:function(){var e=this.isValid(!this.stepStatus())?"complete":"invalid";return this.stepStatus(e)},getOrder:function(){return this.parent},stepStatus:function(e){return arguments.length>0&&(this._stepStatus=e,this.trigger("stepstatuschange",e)),this._stepStatus},requiresFulfillmentInfo:function(){return this.getOrder().get("requiresFulfillmentInfo")},isNonMozuCheckout:function(){var e=this.getOrder().apiModel.getActivePayments();return e&&0===e.length?!1:e&&(t.findWhere(e,{paymentType:"PayWithAmazon"})||t.findWhere(e,{paymentType:"PayPalExpress2"}))},isShippingEditHidden:function(){return d.locals.themeSettings.changeShipping?!1:this.isNonMozuCheckout()},isAwsCheckout:function(){var e=this.getOrder().apiModel.getActivePayments();return e&&!!t.findWhere(e,{paymentType:"PayWithAmazon"})},requiresDigitalFulfillmentContact:function(){return this.getOrder().get("requiresDigitalFulfillmentContact")},edit:function(){this.stepStatus("incomplete")},next:function(){this.submit()&&this.isLoading(!0)}}),c=l.extend({relations:r.Contact.prototype.relations,validation:r.Contact.prototype.validation,digitalOnlyValidation:{email:{pattern:"email",msg:i.getLabel("emailMissing")}},dataTypes:{contactId:function(e){return"new"===e?e:n.MozuModel.DataTypes.Int(e)}},helpers:["contacts"],contacts:function(){var e=this.getOrder().get("customer").get("contacts").toJSON();return e&&e.length>0&&e},initialize:function(){this.on("change:contactId",function(e,t){t&&"new"!==t?e.set(e.getOrder().get("customer").get("contacts").get(t).toJSON(),{silent:!0}):(e.get("address").clear(),e.get("phoneNumbers").clear(),e.unset("id"),e.unset("firstName"),e.unset("lastNameOrSurname"))})},calculateStepStatus:function(){return!this.requiresFulfillmentInfo()&&this.requiresDigitalFulfillmentContact()&&(this.validation=this.digitalOnlyValidation),this.requiresFulfillmentInfo()||this.requiresDigitalFulfillmentContact()?l.prototype.calculateStepStatus.apply(this):this.stepStatus("complete")},getOrder:function(){return this.parent.parent},choose:function(t){var i=parseInt(e(t.currentTarget).val(),10);if(-1!==i){var n=this.get("address"),a=n.get("candidateValidatedAddresses")[i];for(var r in a)n.set(r,a[r])}},toJSON:function(){return this.requiresFulfillmentInfo()||this.requiresDigitalFulfillmentContact()?l.prototype.toJSON.apply(this,arguments):void 0},isDigitalValid:function(){var e=this.get("email");return e?!0:!1},nextDigitalOnly:function(){var e=this.getOrder(),t=this;return this.validate()?!1:(this.getOrder().apiModel.update({fulfillmentInfo:t.toJSON()}).ensure(function(){return t.isLoading(!1),e.messages.reset(),e.syncApiModel(),t.calculateStepStatus(),e.get("billingInfo").calculateStepStatus()}),void 0)},next:function(){if(!this.requiresFulfillmentInfo()&&this.requiresDigitalFulfillmentContact())return this.nextDigitalOnly();var e=this.validate();if(e)return Object.keys(e).forEach(function(t){this.trigger("error",{message:e[t]})},this),!1;"edit"===this.get("updateMode")&&this.set("updateMode","editComplete");var n=this.parent,a=this.getOrder(),r=this,o=d.locals.siteContext.generalSettings.isAddressValidationEnabled,s=d.locals.siteContext.generalSettings.allowInvalidAddresses;this.isLoading(!0);var l=this.get("address"),c=function(){a.messages.reset(),a.syncApiModel(),r.isLoading(!0),a.apiModel.getShippingMethodsFromContact().then(function(e){return n.refreshShippingMethods(e)}).ensure(function(){l.set("candidateValidatedAddresses",null),r.isLoading(!1),n.isLoading(!1),r.calculateStepStatus(),n.calculateStepStatus()})},u=function(){a.syncApiModel(),r.isLoading(!1),n.isLoading(!1),r.stepStatus("invalid")};if(o)if(l.get("candidateValidatedAddresses"))c();else{var p=s?"validateAddressLenient":"validateAddress";l.apiModel[p]().then(function(e){if(e.data&&e.data.addressCandidates&&e.data.addressCandidates.length){if(t.find(e.data.addressCandidates,l.is,l))return l.set("isValidated",!0),c(),void 0;l.set("candidateValidatedAddresses",e.data.addressCandidates),u()}else c()},function(){s?(a.messages.reset(),c()):a.messages.reset({message:i.getLabel("addressValidationError")})})}else c()}}),u=l.extend({initialize:function(){var e=this;this.on("change:availableShippingMethods",function(e){e.updateShippingMethod(e.get("shippingMethodCode"),!0)}),t.defer(function(){e.updateShippingMethod(e.get("shippingMethodCode"),!0)})},relations:{fulfillmentContact:c},validation:{shippingMethodCode:{required:!0,msg:i.getLabel("chooseShippingMethod")}},refreshShippingMethods:function(e){this.set({availableShippingMethods:e}),t.each(["shippingMethodCode","shippingMethodName"],this.unset,this),this.updateShippingMethod()},calculateStepStatus:function(){if(!this.requiresFulfillmentInfo())return this.stepStatus("complete");if("complete"!==this.get("fulfillmentContact").stepStatus())return this.stepStatus("new");var e=this.parent.get("billingInfo");return e&&"new"!==e.stepStatus()?this.stepStatus("complete"):this.stepStatus("incomplete")},updateShippingMethod:function(e,i){var n=this.get("availableShippingMethods"),a=t.findWhere(n,{shippingMethodCode:e}),r=t.min(n,function(e){return e.price});!a&&n&&n.length&&r&&(a=r),n&&n.sort(function(e,t){return e.price-t.price}),a&&(this.set(a),this.applyShipping(i))},applyShipping:function(e){if(this.validate())return!1;var t=this;this.isLoading(!0);var i=this.getOrder();i&&i.apiModel.update({fulfillmentInfo:t.toJSON()}).then(function(){var e=t.parent.get("billingInfo");e&&(e.loadCustomerDigitalCredits(),e.updatePurchaseOrderAmount())}).ensure(function(){t.isLoading(!1),t.calculateStepStatus(),t.parent.get("billingInfo").calculateStepStatus(),e&&t.parent.messages.reset(t.parent.get("messages"))})},next:function(){this.stepStatus("complete"),this.parent.get("billingInfo").calculateStepStatus()}}),p=l.extend({mozuType:"payment",validation:{paymentType:{fn:"validatePaymentType"},savedPaymentMethodId:{fn:"validateSavedPaymentMethodId"},"billingContact.email":{pattern:"email",msg:i.getLabel("emailMissing")}},dataTypes:{isSameBillingShippingAddress:n.MozuModel.DataTypes.Boolean,creditAmountToApply:n.MozuModel.DataTypes.Float},relations:{billingContact:r.Contact,card:s.CreditCardWithCVV,check:s.Check,purchaseOrder:s.PurchaseOrder},validatePaymentType:function(e){var t=this.getOrder(),n=t.apiModel.getCurrentPayment(),a=i.getLabel("paymentTypeMissing");return e?("StoreCredit"===e||"GiftCard"===e)&&this.nonStoreCreditTotal()>0&&!n?a:void 0:a},validateSavedPaymentMethodId:function(){if(this.get("usingSavedCard")){var e=this.get("savedPaymentMethodId");if(!e)return i.getLabel("selectASavedCard")}},helpers:["acceptsMarketing","savedPaymentMethods","availableStoreCredits","applyingCredit","maxCreditAmountToApply","activeStoreCredits","nonStoreCreditTotal","activePayments","hasSavedCardPayment","availableDigitalCredits","digitalCreditPaymentTotal","isAnonymousShopper","visaCheckoutFlowComplete","isExternalCheckoutFlowComplete","checkoutFlow"],acceptsMarketing:function(){return this.getOrder().get("acceptsMarketing")},isExternalCheckoutFlowComplete:function(){return"Mozu"!==this.get("paymentWorkflow")},visaCheckoutFlowComplete:function(){return"VisaCheckout"===this.get("paymentWorkflow")},checkoutFlow:function(){return this.get("paymentWorkflow")},cancelExternalCheckout:function(){var e=this,t=this.getOrder(),i=t.apiModel.getCurrentPayment();return t.apiVoidPayment(i.id).then(function(){e.clear(),e.stepStatus("incomplete"),e.setPurchaseOrderInfo(),e.setDefaultPaymentType(e),"PayWithAmazon"===i.paymentType&&e.trigger("removeAmazonPayment")})},activePayments:function(){return this.getOrder().apiModel.getActivePayments()},hasSavedCardPayment:function(){var e=this.getOrder().apiModel.getCurrentPayment();return!!(e&&e.billingInfo.card&&e.billingInfo.card.paymentServiceCardId)},nonStoreCreditTotal:function(){var e,i=this,n=this.getOrder(),a=n.get("total"),r=this.activeStoreCredits();return r?(e=a-t.reduce(r,function(e,t){return e+t.amountRequested},0),i.roundToPlaces(e,2)):a},resetAddressDefaults:function(){var e=this.get("billingContact").get("address"),t=e.defaults;e.set("countryCode",t.countryCode),e.set("addressType",t.addressType),e.set("candidateValidatedAddresses",t.candidateValidatedAddresses)},savedPaymentMethods:function(){var e=this.getOrder().get("customer").get("cards").toJSON();return e&&e.length>0&&e},activeStoreCredits:function(){var e=this.getOrder().apiModel.getActiveStoreCredits();return e&&e.length>0&&e},availableStoreCredits:function(){var e=this.getOrder(),i=e.get("customer"),n=i&&i.get("credits"),a=this.activeStoreCredits(),r=n&&t.compact(t.map(n.models,function(e){return"StoreCredit"!==e.creditType&&"GiftCard"!==e.creditType?!1:(e=t.clone(e),a&&t.each(a,function(t){t.billingInfo.storeCreditCode===e.code&&(e.currentBalance-=t.amountRequested)}),e.currentBalance>0?e:!1)}));return r&&r.length>0&&r},applyingCredit:function(){return this._applyingCredit},maxCreditAmountToApply:function(){var e=this.getOrder(),t=e.get("amountRemainingForPayment"),i=this.applyingCredit();return i?Math.min(i.currentBalance,t).toFixed(2):void 0},beginApplyCredit:function(){var e=this.get("selectedCredit");if(this._oldPaymentType=this.get("paymentType"),e){var i=t.findWhere(this.availableStoreCredits(),{code:e});i&&(this._applyingCredit=i,this.set("creditAmountToApply",this.maxCreditAmountToApply()))}},closeApplyCredit:function(){delete this._applyingCredit,this.unset("selectedCredit"),this.set("paymentType",this._oldPaymentType)},finishApplyCredit:function(){var e=this,t=e.getOrder();return t.apiAddStoreCredit({storeCreditCode:this.get("selectedCredit"),amount:this.get("creditAmountToApply")}).then(function(i){return t.set(i.data),e.closeApplyCredit(),t.update()})},onCreditAmountChanged:function(e,t){this.applyDigitalCredit(e.get("code"),t)},loadCustomerDigitalCredits:function(){var e=this,i=this.getOrder(),n=i.get("customer"),a=this.activeStoreCredits(),r=n.get("credits");if(r&&r.length>0){var o=new Date,s=new Date(2076,6,4),d=r.filter(function(e){var t=e.get("currentBalance"),i=e.get("expirationDate"),n=i?new Date(i):s;return!t||0>=t||o>n});t.each(d,function(e){r.remove(e)})}if(e._cachedDigitalCredits=r,a){var l=t.filter(a,function(t){var i=e._cachedDigitalCredits.find(function(e){return e.get("code").toLowerCase()===t.billingInfo.storeCreditCode.toLowerCase()});return i?(i.set("isEnabled",!0),i.set("creditAmountApplied",t.amountRequested),i.set("remainingBalance",i.calculateRemainingBalance()),!1):!0});l&&this.convertPaymentsToDigitalCredits(l,n)}},convertPaymentsToDigitalCredits:function(e,i){var n=this;t.each(e,function(e){var t=e;return n.retrieveDigitalCredit(i,t.billingInfo.storeCreditCode,n,t.amountRequested).then(function(e){return n.trigger("orderPayment",n.getOrder().data,n),e})})},availableDigitalCredits:function(){return this._cachedDigitalCredits||this.loadCustomerDigitalCredits(),this._cachedDigitalCredits&&this._cachedDigitalCredits.length>0&&this._cachedDigitalCredits},refreshBillingInfoAfterAddingStoreCredit:function(e,i){var n=this,a=this.activePayments(),r=t.filter(a,function(e){return"StoreCredit"!==e.paymentType}).length>0;(e.get("amountRemainingForPayment")>=0&&!r||e.get("amountRemainingForPayment")<0&&r)&&(e.get("billingInfo").clear(),e.set(i,{silent:!0})),n.setPurchaseOrderInfo(),n.setDefaultPaymentType(n),n.trigger("orderPayment",i,n)},applyDigitalCredit:function(e,n,r){var o=this,s=o.getOrder(),d=null;this._oldPaymentType=this.get("paymentType");var l=this._cachedDigitalCredits.filter(function(t){return t.get("code").toLowerCase()===e.toLowerCase()});if(!l||0===l.length)return o.deferredError(i.getLabel("digitalCodeAlreadyUsed",e),o);l=l[0];var c=l.get("creditAmountApplied"),u=l.get("isEnabled");n||0===n||(n=o.getMaxCreditToApply(l,o)),l.set("creditAmountApplied",n),l.set("remainingBalance",l.calculateRemainingBalance()),l.set("isEnabled",r),n>0&&(n=o.roundToPlaces(n,2));var p=this.activeStoreCredits();if(p){var h=t.find(p,function(t){return"Voided"!==t.status&&t.billingInfo&&t.billingInfo.storeCreditCode.toLowerCase()===e.toLowerCase()});if(h){if(this.areNumbersEqual(h.amountRequested,n)){var m=a.defer();return m.reject(),m.promise}return 0===n?s.apiVoidPayment(h.id).then(function(e){return s.set(e.data),o.setPurchaseOrderInfo(),o.setDefaultPaymentType(o),o.trigger("orderPayment",e.data,o),e}):(d=o.getMaxCreditToApply(l,o,h.amountRequested),n>d?(l.set("creditAmountApplied",c),l.set("isEnabled",u),l.set("remainingBalance",l.calculateRemainingBalance()),o.deferredError(i.getLabel("digitalCreditExceedsBalance"),o)):s.apiVoidPayment(h.id).then(function(t){return s.set(t.data),s.apiAddStoreCredit({storeCreditCode:e,amount:n,email:o.get("billingContact").get("email")}).then(function(e){return o.refreshBillingInfoAfterAddingStoreCredit(s,e.data),e})}))}}return 0===n?this.getOrder():(d=o.getMaxCreditToApply(l,o),n>d?(l.set("creditAmountApplied",c),l.set("remainingBalance",l.calculateRemainingBalance()),l.set("isEnabled",u),o.deferredError(i.getLabel("digitalCreditExceedsBalance"),o)):s.apiAddStoreCredit({storeCreditCode:e,amount:n,email:o.get("billingContact").get("email")}).then(function(e){return o.refreshBillingInfoAfterAddingStoreCredit(s,e.data),e}))},deferredError:function(e,t){t.trigger("error",{message:e});var i=a.defer();return i.reject(),i.promise},areNumbersEqual:function(e,t){var i=.01;return Math.abs(e-t)<i},retrieveDigitalCredit:function(e,t,n,a){var r=this;return e.apiGetDigitalCredit(t).then(function(e){var o=new s.DigitalCredit(e.data);o.set("isTiedToCustomer",!1);var d=function(){var e=new Date,t=o.get("activationDate")?new Date(o.get("activationDate")):null,n=o.get("expirationDate")?new Date(o.get("expirationDate")):null;return n&&e>n?r.deferredError(i.getLabel("expiredCredit",n.toLocaleDateString()),r):t&&t>e?r.deferredError(i.getLabel("digitalCreditNotYetActive",t.toLocaleDateString()),r):!o.get("currentBalance")||o.get("currentBalance")<=0?r.deferredError(i.getLabel("digitalCreditNoRemainingFunds"),r):null},l=d();if(null!==l)return null;var c=n.getMaxCreditToApply(o,n,a);return a&&c>a&&(c=a),o.set("creditAmountApplied",c),o.set("remainingBalance",o.calculateRemainingBalance()),o.set("isEnabled",!0),n._cachedDigitalCredits.push(o),n.applyDigitalCredit(t,c,!0),n.trigger("sync",o),o})},getDigitalCredit:function(){var e=this,t=e.getOrder(),n=t.get("customer"),r=this.get("digitalCreditCode"),o=this._cachedDigitalCredits.filter(function(e){return e.get("code").toLowerCase()===r.toLowerCase()});if(o&&o.length>0){e.trigger("error",{message:i.getLabel("digitalCodeAlreadyUsed",r)});var s=a.defer();return s.reject(),s.promise}return e.isLoading(!0),e.retrieveDigitalCredit(n,r,e).then(function(){return e.isLoading(!1),e})},getMaxCreditToApply:function(e,t,i){var n=t.nonStoreCreditTotal();i&&(n+=i);var a=n<e.get("currentBalance")?n:e.get("currentBalance");return t.roundToPlaces(a,2)},roundToPlaces:function(e,t){var i=Math.pow(10,t);return Math.round(e*i)/i},digitalCreditPaymentTotal:function(){var e=this.activeStoreCredits();return e?t.reduce(e,function(e,t){return e+t.amountRequested},0):null},addRemainingCreditToCustomerAccount:function(e,t){var n=this,a=n._cachedDigitalCredits.find(function(t){return t.code.toLowerCase()===e.toLowerCase()});return a?(a.set("addRemainderToCustomer",t),a):n.deferredError(i.getLabel("genericNotFound"),n)},getDigitalCreditsToAddToCustomerAccount:function(){return this._cachedDigitalCredits.where({isEnabled:!0,addRemainderToCustomer:!0,isTiedToCustomer:!1})},isAnonymousShopper:function(){var e=this.getOrder(),t=e.get("customer");return!t||!t.id||t.id<=1},removeCredit:function(e){var t=this.getOrder();return t.apiVoidPayment(e).then(t.update)},syncPaymentMethod:function(e,t){t&&"new"!==t?(e.setSavedPaymentMethod(t),e.set("usingSavedCard",!0)):(e.get("billingContact").clear(),e.get("card").clear(),e.get("check").clear(),e.unset("paymentType"),e.set("usingSavedCard",!1))},setSavedPaymentMethod:function(e,t){var n=this,a=n.getOrder().get("customer"),r=t||a.get("cards").get(e),o=r&&a.get("contacts").get(r.get("contactId"));return r&&(n.get("billingContact").set(o.toJSON(),{silent:!0}),n.get("card").set(r.toJSON()),n.set("paymentType","CreditCard"),n.set("usingSavedCard",!0),i.getThemeSetting("isCvvSuppressed")&&(n.get("card").set("isCvvOptional",!0),n.parent.get("amountRemainingForPayment")>0))?n.applyPayment():void 0},getPaymentTypeFromCurrentPayment:function(){var e=this.get("paymentType"),t=this.get("paymentWorkflow"),i=this.getOrder().apiModel.getCurrentPayment(),n=i&&i.billingInfo.paymentType,a=i&&i.billingInfo.paymentWorkflow,r=i&&i.billingInfo.billingContact,o=i&&i.billingInfo.card,s=i&&i.billingInfo.purchaseorder,l=d.locals.siteContext.checkoutSettings.purchaseOrder?d.locals.siteContext.checkoutSettings.purchaseOrder.isEnabled:!1,c=this.getOrder().get("customer").get("purchaseOrder")?this.getOrder().get("customer").get("purchaseOrder").isEnabled:!1;l&&c&&!i&&(n="PurchaseOrder"),!n||n===e&&a===t||(this.set("paymentType",n,{silent:!0}),this.set("paymentWorkflow",a,{silent:!0}),this.set("card",o,{silent:!0}),this.set("billingContact",r,{silent:!0}),this.set("purchaseOrder",s,{silent:!0}))},edit:function(){this.getPaymentTypeFromCurrentPayment(),l.prototype.edit.apply(this,arguments)},updatePurchaseOrderAmount:function(){var e=this,t=e.getOrder(),i=this.get("purchaseOrder"),n=i.get("totalAvailableBalance"),a=t.get("amountRemainingForPayment"),r=n>a?a:n;!this.get("purchaseOrder").get("isEnabled")&&this.get("purchaseOrder").selected||t.get("payments").length>0||(i.set("amount",r),a>r&&i.set("splitPayment",!0),e.trigger("stepstatuschange"))},isPurchaseOrderEnabled:function(){var e=this,t=e.getOrder(),i=t?t.get("customer").get("purchaseOrder"):null,n=d.locals.siteContext.checkoutSettings.purchaseOrder?d.locals.siteContext.checkoutSettings.purchaseOrder.isEnabled:!1,a=i?i.isEnabled:!1,r=a?i.totalAvailableBalance>0:!1,o=n&&a&&r;return o},setPurchaseOrderInfo:function(){var e=this,t=e.getOrder(),i=t?t.get("customer").get("purchaseOrder"):null,n=this.isPurchaseOrderEnabled(),a=e.get("purchaseOrder"),r=require.mozuData("checkout").siteId,o=a.get("amount");if(a.set("isEnabled",n),n){a.deflateCustomFields();for(var s in a.validation)this.validation["purchaseOrder."+s]||(this.validation["purchaseOrder."+s]=a.validation[s]),this.parent.validation["billingInfo.purchaseOrder."+s]||(this.parent.validation["billingInfo.purchaseOrder."+s]=a.validation[s]);var d=i.totalAvailableBalance>t.get("amountRemainingForPayment")?t.get("amountRemainingForPayment"):i.totalAvailableBalance;if(o&&o===d||a.set("amount",d),a.set("totalAvailableBalance",i.totalAvailableBalance),a.set("availableBalance",i.availableBalance),a.set("creditLimit",i.creditLimit),i.totalAvailableBalance<t.get("amountRemainingForPayment")&&a.set("splitPayment",!0),0===a.get("paymentTermOptions").length){var l=[];i.paymentTerms.forEach(function(e){if(e.siteId===r){var t={};t.code=e.code,t.description=e.description,l.push(e)}}),a.set("paymentTermOptions",l,{silent:!0})}var c=a.get("paymentTermOptions");if(!a.get("paymentTerm").get("code")&&1===c.length){var u={};u.code=c.models[0].get("code"),u.description=c.models[0].get("description"),a.set("paymentTerm",u)}this.setPurchaseOrderBillingInfo()}},setPurchaseOrderBillingInfo:function(){var e=this,t=e.getOrder(),i=this.isPurchaseOrderEnabled(),n=e.get("purchaseOrder"),a=t?t.get("customer").get("contacts"):null;if(i&&n.selected&&a.length>0){var r=a.models.find(function(e){return e.get("isPrimaryBillingContact")});r&&(this.set("billingContact",r,{silent:!0}),n.set("usingBillingContact",!0))}},setPurchaseOrderPaymentTerm:function(e){var t=this.get("purchaseOrder"),i=t.get("paymentTermOptions"),n=i.find(function(t){return t.get("code")===e});t.set("paymentTerm",n,{silent:!0})},initialize:function(){var e=this;t.defer(function(){e.setPurchaseOrderInfo(),e.getPaymentTypeFromCurrentPayment();var t=e.get("card.paymentServiceCardId");e.set("savedPaymentMethodId",t,{silent:!0}),e.setSavedPaymentMethod(t),t||e.setDefaultPaymentType(e),e.on("change:usingSavedCard",function(e,t){t?(e.set("isSameBillingShippingAddress",!1),e.setSavedPaymentMethod(e.get("savedPaymentMethodId"))):(e.get("card").clear(),e.set("usingSavedCard",!1))})});var i=this.get("billingContact");this.on("change:paymentType",this.selectPaymentType),this.selectPaymentType(this,this.get("paymentType")),this.on("change:isSameBillingShippingAddress",function(e,t){t&&i.set(this.parent.get("fulfillmentInfo").get("fulfillmentContact").toJSON(),{silent:!0})}),this.on("change:savedPaymentMethodId",this.syncPaymentMethod),this._cachedDigitalCredits=null,t.bindAll(this,"applyPayment","markComplete")},selectPaymentType:function(e,t){e.changed&&e.changed.paymentWorkflow||e.get("paymentWorkflow")||e.set("paymentWorkflow","Mozu"),e.get("check").selected="Check"===t,e.get("card").selected="CreditCard"===t,e.get("purchaseOrder").selected="PurchaseOrder"===t,"PurchaseOrder"===t&&e.setPurchaseOrderBillingInfo()},setDefaultPaymentType:function(e){e.isPurchaseOrderEnabled()?(e.set("paymentType","PurchaseOrder"),e.selectPaymentType(e,"PurchaseOrder")):(e.set("paymentType","CreditCard"),e.selectPaymentType(e,"CreditCard"),e.savedPaymentMethods()&&e.savedPaymentMethods().length>0&&e.set("usingSavedCard",!0))},calculateStepStatus:function(){var e="complete"===this.parent.get("fulfillmentInfo").stepStatus(),n=this.activePayments(),a=n.length>0,r=n&&!!t.findWhere(n,{paymentType:"CreditCard"}),o=this.parent.get("amountRemainingForPayment")<=0;return this.isNonMozuCheckout()?this.stepStatus("complete"):r&&!i.getThemeSetting("isCvvSuppressed")?this.stepStatus("incomplete"):e?a&&(o||"PaypalExpress"===this.get("paymentType")&&-1!==window.location.href.indexOf("PaypalExpress=complete"))?this.stepStatus("complete"):this.stepStatus("incomplete"):this.stepStatus("new")},hasPaymentChanged:function(e){function i(e){return{paymentType:e.paymentType,billingContact:t.extend(t.pick(e.billingContact,"email","firstName","lastNameOrSurname","phoneNumbers"),{address:e.billingContact.address?t.pick(e.billingContact.address,"address1","address2","addressType","cityOrTown","countryCode","postalOrZipCode","stateOrProvince"):{}}),card:e.card?t.extend(t.pick(e.card,"expireMonth","expireYear","nameOnCard","isSavedCardInfo"),{cardType:e.card.paymentOrCardType||e.card.cardType,cardNumber:e.card.cardNumberPartOrMask||e.card.cardNumberPart||e.card.cardNumber,id:e.card.paymentServiceCardId||e.card.id,isCardInfoSaved:e.card.isCardInfoSaved||!1}):{},purchaseOrder:e.purchaseOrder||{},check:e.check||{}}}var n=i(e.billingInfo),a=i(this.toJSON());return"VisaCheckout"===e.paymentWorkflow&&(a.billingContact.address.addressType=n.billingContact.address.addressType),!t.isEqual(n,a)},submit:function(){var e=this.getOrder();e.syncBillingAndCustomerEmail();var t=e.apiModel.getCurrentPayment();this.get("card").set("isSavedCard",e.get("billingInfo.usingSavedCard")),t&&this.get("card").set("isVisaCheckout","visacheckout"===t.paymentWorkflow.toLowerCase());var i=this.validate();if(this.nonStoreCreditTotal()>0&&i){var n={items:[]};for(var a in i)if(i.hasOwnProperty(a)){var r={};r.name=a,r.message=a.substring(0,".")+i[a],n.items.push(r)}return n.items.length>0&&e.onCheckoutError(n),!1}var o=this.get("card");return"purchaseorder"===this.get("paymentType").toLowerCase()&&this.get("purchaseOrder").inflateCustomFields(),t?this.hasPaymentChanged(t)?e.apiVoidPayment(t.id).then(this.applyPayment):o.get("cvv")&&o.get("paymentServiceCardId")?o.apiSave().then(this.markComplete,e.onCheckoutError):(this.markComplete(),void 0):this.applyPayment()},applyPayment:function(){var e=this,i=this.getOrder();return"PayWithAmazon"==this.get("paymentWorkflow")&&this.unset("paymentWorkflow"),this.syncApiModel(),this.nonStoreCreditTotal()>0?i.apiAddPayment().then(function(){var n,a,r=i.apiModel.getCurrentPayment(),o=i.apiModel.getActivePayments(),s=o&&t.findWhere(o,{paymentType:"CreditCard"});if(!s&&e.get("card")&&e.get("card").clear(),r)switch(r.paymentType){case"CreditCard":n=e.get("card"),a=n.get("cvv"),a&&-1===a.indexOf("*")&&n.set("cvv","***"),e.markComplete();break;default:e.markComplete()}}):(this.markComplete(),void 0)},markComplete:function(){this.stepStatus("complete"),this.isLoading(!1);var e=this.getOrder();t.defer(function(){e.isReady(!0)})},toJSON:function(){var e=l.prototype.toJSON.apply(this,arguments);return 0===this.nonStoreCreditTotal()&&e.billingContact&&delete e.billingContact.address,e.billingContact&&!e.billingContact.email&&(e.billingContact.email=this.getOrder().get("customer.emailAddress")),e}}),h=n.MozuModel.extend(),m={emailAddress:{fn:function(e){return!this.attributes.createAccount||e&&e.match(n.Validation.patterns.email)?void 0:i.getLabel("emailMissing")}},password:{fn:function(e){return this.attributes.createAccount&&!e?i.getLabel("passwordMissing"):void 0}},confirmPassword:{fn:function(e){return this.attributes.createAccount&&e!==this.get("password")?i.getLabel("passwordsDoNotMatch"):void 0}}};i.getThemeSetting("requireCheckoutAgreeToTerms")&&(m.agreeToTerms={acceptance:!0,msg:i.getLabel("didNotAgreeToTerms")});var g=require.mozuData("pagecontext").storefrontOrderAttributes;if(g&&g.length>0){var f=t.filter(g,function(e){return e.isRequired&&e.isVisible&&"AdminEntered"!==e.valueType});f.forEach(function(e){e.isRequired&&(m["orderAttribute-"+e.attributeFQN]={required:!0,msg:e.content.value+" "+i.getLabel("missing")})},this)}var v=n.MozuModel.extend({mozuType:"order",handlesMessages:!0,relations:{fulfillmentInfo:u,billingInfo:p,shopperNotes:h,customer:r.Customer},validation:m,dataTypes:{createAccount:n.MozuModel.DataTypes.Boolean,acceptsMarketing:n.MozuModel.DataTypes.Boolean,amountRemainingForPayment:n.MozuModel.DataTypes.Float},initialize:function(e){var n=this,a=require.mozuData("user");t.defer(function(){var e=n.apiModel.getCurrentPayment(),r=n.apiModel.getActivePayments(),o=n.get("fulfillmentInfo"),s=o.get("fulfillmentContact"),d=n.get("billingInfo"),l=[o,s,d],c=e&&e.paymentWorkflow,u=r&&t.findWhere(r,{paymentWorkflow:"VisaCheckout"}),p=function(){return"completecompletecomplete"===t.reduce(l,function(e,t){return e+t.stepStatus()},"")},h=p();u&&(t.each(t.filter(n.apiModel.getActivePayments(),function(e){return"StoreCredit"!==e.paymentType&&"GiftCard"!==e.paymentType&&"VisaCheckout"!=e.paymentWorkflow}),function(e){n.apiVoidPayment(e.id)}),c=u.paymentWorkflow,d.unset("billingContact"),d.set("card",u.billingInfo.card),d.set("billingContact",u.billingInfo.billingContact,{silent:!0})),c&&(d.set("paymentWorkflow",c),d.get("card").set({isCvvOptional:i.getThemeSetting("isCvvSuppressed"),paymentWorkflow:c}),d.trigger("stepstatuschange")),n.isReady(h),t.each(l,function(e){n.listenTo(e,"stepstatuschange",function(){t.defer(function(){n.isReady(p())})})}),n.get("requiresFulfillmentInfo")||(n.validation=t.pick(n.constructor.prototype.validation,t.filter(t.keys(n.constructor.prototype.validation),function(e){return-1===e.indexOf("fulfillment")}))),n.get("billingInfo.billingContact").on("change:email",function(e,t){n.set("email",t)});var m=d.get("billingContact.email");!m&&a.email&&d.set("billingContact.email",a.email),n.applyAttributes()}),a.isAuthenticated&&this.set("customer",{id:a.accountId}),null===e.acceptsMarketing&&n.set("acceptsMarketing",!0),t.bindAll(this,"update","onCheckoutSuccess","onCheckoutError","addNewCustomer","saveCustomerCard","apiCheckout","addDigitalCreditToCustomerAccount","addCustomerContact","addBillingContact","addShippingContact","addShippingAndBillingContact")},applyAttributes:function(){var e=require.mozuData("pagecontext").storefrontOrderAttributes;e&&e.length>0&&this.set("orderAttributes",e)},processDigitalWallet:function(e,i){var n=this;return n.runForAllSteps(function(){this.isLoading(!0)}),n.trigger("beforerefresh"),a.all.apply(a,t.map(t.filter(n.apiModel.getActivePayments(),function(e){return"StoreCredit"!==e.paymentType&&"GiftCard"!==e.paymentType}),function(e){return n.apiVoidPayment(e.id)})).then(function(){return n.apiProcessDigitalWallet({digitalWalletData:JSON.stringify(i)}).then(function(){n.updateVisaCheckoutBillingInfo(),n.runForAllSteps(function(){this.trigger("sync"),this.isLoading(!1)}),n.updateShippingInfo()})})},updateShippingInfo:function(){var e=this;this.apiModel.getShippingMethods().then(function(t){e.get("fulfillmentInfo").refreshShippingMethods(t)})},updateVisaCheckoutBillingInfo:function(){var e=this.get("billingInfo"),i=this.apiModel.getActivePayments(),n=i&&t.findWhere(i,{paymentWorkflow:"VisaCheckout"});n&&(e.set("card",n.billingInfo.card),e.set("usingSavedCard",!1),e.unset("savedPaymentMethodId"),e.set("card",n.billingInfo.card),e.unset("billingContact"),e.set("billingContact",n.billingInfo.billingContact,{silent:!0}),e.set("paymentWorkflow",n.paymentWorkflow),e.set("paymentType",n.paymentType),this.refresh())},addCoupon:function(){var e=this,n=this.get("couponCode"),r=e.get("orderDiscounts");if(r&&t.findWhere(r,{couponCode:n})){var o=a.defer();return o.reject(),o.promise.otherwise(function(){e.trigger("error",{message:i.getLabel("promoCodeAlreadyUsed",n)})}),o.promise}return this.isLoading(!0),this.apiAddCoupon(this.get("couponCode")).then(function(){e.get("billingInfo").trigger("sync"),e.set("couponCode","");var a=t.flatten(t.pluck(e.get("items"),"productDiscounts")),r=t.flatten(t.pluck(t.flatten(t.pluck(e.get("items"),"shippingDiscounts")),"discount")),o=t.flatten(t.pluck(e.get("shippingDiscounts"),"discount")),s=e.get("orderDiscounts").concat(a).concat(r).concat(o),d=n.toLowerCase(),l=function(e){return(e.couponCode||"").toLowerCase()===d};s&&t.find(s,l)?0===e.get("total")&&e.trigger("complete"):e.trigger("error",{message:i.getLabel("promoCodeError",n)}),e.get("billingInfo").updatePurchaseOrderAmount(),e.isLoading(!1)})},onCheckoutSuccess:function(){this.isLoading(!0),this.trigger("complete")},onCheckoutError:function(n){var a=this,r=!1;if(a.isLoading(!1),!n||!n.items||0===n.items.length){if(-1!=n.message.indexOf("10486")){var o=d.locals.siteContext,s=t.findWhere(o.checkoutSettings.externalPaymentWorkflowSettings,{name:"PayPalExpress2"}),l=t.findWhere(s.credentials,{apiName:"environment"}),c="";return c="sandbox"===l.value.toLowerCase()?"https://www.sandbox.paypal.com":"https://www.paypal.com",window.location.href=c+"/cgi-bin/webscr?cmd=_express-checkout&token="+a.get("payments")[a.get("payments").length-1].externalTransactionId,void 0}n={items:[{message:n.message||i.getLabel("unknownError")}]}}throw e.each(n.items,function(e,t){"ADD_CUSTOMER_FAILED"===t.name&&t.message.toLowerCase().indexOf("invalid parameter: password")&&(r=!0,a.trigger("passwordinvalid",t.message.substring(t.message.indexOf("Password")))),"ADD_CUSTOMER_FAILED"===t.errorCode&&t.message.toLowerCase().indexOf("invalid parameter: emailaddress")&&(r=!0,a.trigger("userexists",a.get("emailAddress")))}),this.trigger("error",n),r||a.messages.reset(n.items),a.isSubmitting=!1,n},addNewCustomer:function(){var e=this,t=this.get("billingInfo"),i=t.get("billingContact"),n=this.get("emailAddress"),r=function(t){if(t&&("customer"===t.type||"login"===t.type)){var i;"customer"===t.type&&(i=t.data),"login"===t.type&&(i=t.data.customerAccount),i&&i.id&&(e.set("customer",i),a.off("sync",r),a.off("spawn",r))}};return a.on("sync",r),a.on("spawn",r),this.apiAddNewCustomer({account:{emailAddress:n,userName:n,firstName:i.get("firstName")||this.get("fulfillmentInfo.fulfillmentContact.firstName"),lastName:i.get("lastNameOrSurname")||this.get("fulfillmentInfo.fulfillmentContact.lastNameOrSurname"),acceptsMarketing:e.get("acceptsMarketing")},password:this.get("password")}).then(function(t){return e.customerCreated=!0,t
},function(t){throw e.customerCreated=!1,e.isSubmitting=!1,t})},addBillingContact:function(){return this.addCustomerContact("billingInfo","billingContact",[{name:"Billing"}])},addShippingContact:function(){return this.addCustomerContact("fulfillmentInfo","fulfillmentContact",[{name:"Shipping"}])},addShippingAndBillingContact:function(){return this.addCustomerContact("fulfillmentInfo","fulfillmentContact",[{name:"Shipping"},{name:"Billing"}])},addCustomerContact:function(e,i,n){var r=this.get("customer"),o=this.get(e),s=[function(){return c.id&&c.id>0?r.apiModel.updateContact(c):((-1===c.id||1===c.id||"new"===c.id)&&delete c.id,r.apiModel.addContact(c).then(function(e){return c.id=e.data.id,e}))}],d=o.get(i),l=this.get("customer").get("contacts");d.get("accountId")||d.set("accountId",r.id);var c=d.toJSON();this.isSavingNewCustomer()?t.each(n,function(e){e.isPrimary=!0}):s.unshift(function(){return r.apiModel.getContacts().then(function(e){t.each(n,function(i){var n=t.find(e.data.items,function(e){return t.find(e.types||[],function(e){return e.name===i.name&&e.isPrimary})});i.isPrimary=!n})})}),c.email||(c.email=this.get("emailAddress")||r.get("emailAddress")||require.mozuData("user").email);var u=c.contactId;if(u&&(c.id=u),c.id&&-1!==c.id&&1!==c.id&&"new"!==c.id){var p=l.get(c.id).toJSON();if(this.isContactModified(c,p))return c.types=c.types?c.types:p.types,a.steps(s);var h=a.defer();return h.resolve(),h.promise}return c.types=n,a.steps(s)},isContactModified:function(e,i){var n=e&&i&&e.id===i.id,a=n&&!t.isEqual(e.address,i.address),r=n&&e.phoneNumbers.home&&(!i.phoneNumbers.home||e.phoneNumbers.home!==i.phoneNumbers.home);return n&&(a||r||e.email!==i.email||e.firstName!==i.firstName||e.lastNameOrSurname!==i.lastNameOrSurname)},saveCustomerCard:function(){var e=this,t=this.get("customer"),i=this.get("billingInfo"),n=i.get("isSameBillingShippingAddress"),a=this.isSavingNewCustomer(),r=i.get("billingContact").toJSON(),o=i.get("card"),s=function(){e.cardsSaved=e.cardsSaved||t.get("cards").reduce(function(e,t){return e[t.id]=!0,e},{});var i=e.cardsSaved[o.get("id")||o.get("paymentServiceCardId")]?"updateCard":"addCard";return o.set("contactId",r.id),t.apiModel[i](o.toJSON()).then(function(t){return e.cardsSaved[t.data.id]=!0,t})},d=r.contactId;return d&&(r.id=d),r.id&&-1!==r.id&&1!==r.id&&"new"!==r.id?s():(r.types=n?[{name:"Shipping",isPrimary:a},{name:"Billing",isPrimary:a}]:[{name:"Billing",isPrimary:a}],this.addCustomerContact("billingInfo","billingContact",r.types).then(function(e){return r.id=e.data.id,e}).then(s))},setFulfillmentContactEmail:function(){var e=this.get("fulfillmentInfo.fulfillmentContact.email"),t=this.get("email");e||this.set("fulfillmentInfo.fulfillmentContact.email",t)},syncBillingAndCustomerEmail:function(){var e=this.get("billingInfo.billingContact.email"),t=this.get("emailAddress")||require.mozuData("user").email;t||this.set("emailAddress",e),e||this.set("billingInfo.billingContact.email",t)},addDigitalCreditToCustomerAccount:function(){var e=this.get("billingInfo"),i=this.get("customer"),n=e.getDigitalCreditsToAddToCustomerAccount();return n?t.each(n,function(e){return i.apiAddStoreCredit(e.get("code"))}):void 0},isSavingNewCustomer:function(){return this.get("createAccount")&&!this.customerCreated},isNonMozuCheckout:function(){var e=this.apiModel.getActivePayments();return e&&0===e.length?!1:e&&(t.findWhere(e,{paymentType:"PayWithAmazon"})||t.findWhere(e,{paymentType:"PayPalExpress2"}))},submit:function(){var e=this,i=this.get("billingInfo"),n=i.get("billingContact"),r=i.get("isSameBillingShippingAddress"),o=!1,s=this.isSavingNewCustomer(),d=require.mozuData("user").isAuthenticated,l=i.nonStoreCreditTotal(),c=this.get("requiresFulfillmentInfo"),u=l>0,p=(this.apiModel.getCurrentPayment(),[function(){return e.update({ipAddress:e.get("ipAddress"),shopperNotes:e.get("shopperNotes").toJSON()})}]),h=require.mozuData("pagecontext").storefrontOrderAttributes;if(h&&h.length>0){var m=[];h.forEach(function(t){var i=e.get("orderAttribute-"+t.attributeFQN);i&&m.push({fullyQualifiedName:t.attributeFQN,values:[i]})}),m.length>0&&p.push(function(){return e.apiUpdateAttributes(m)},function(){return e.apiGet()})}if(this.isNonMozuCheckout()&&n.set("address",null),!this.isSubmitting){if(this.isSubmitting=!0,u&&!n.isValid()){var g=this.apiModel.getCurrentPayment().billingInfo;i.set(g,{silent:!0})}if(this.syncBillingAndCustomerEmail(),this.setFulfillmentContactEmail(),l>0&&this.validate()&&(!this.isNonMozuCheckout()||this.validate().agreeToTerms))return this.isSubmitting=!1,!1;this.isLoading(!0),s&&p.unshift(this.addNewCustomer);var f=this.apiModel.getActivePayments(),v=!1;if(null!==f&&f.length>0){var y=t.findWhere(f,{paymentType:"CreditCard"});y&&y.billingInfo&&y.billingInfo.card&&(v=y.billingInfo.card.isCardInfoSaved,i.set("card",y.billingInfo.card))}v&&(this.get("createAccount")||d)&&(o=!0,p.push(this.saveCustomerCard)),(this.get("createAccount")||d)&&i.getDigitalCreditsToAddToCustomerAccount().length>0&&p.push(this.addDigitalCreditToCustomerAccount),this.isNonMozuCheckout()||!d&&!s||(r||o?r&&!o?p.push(this.addShippingAndBillingContact):!r&&o&&c&&p.push(this.addShippingContact):(c&&p.push(this.addShippingContact),u&&p.push(this.addBillingContact))),p.push(this.apiCheckout),a.steps(p).then(this.onCheckoutSuccess,this.onCheckoutError)}},update:function(){var e=this.toJSON();return this.apiModel.update(e)},refresh:function(){var e=this;return this.trigger("beforerefresh"),this.apiGet().then(function(){e.trigger("refresh")})},runForAllSteps:function(e){var i=this;t.each(["fulfillmentInfo.fulfillmentContact","fulfillmentInfo","billingInfo"],function(t){e.call(i.get(t))})},isReady:function(e){this.set("isReady",e)},toJSON:function(e){var t=n.MozuModel.prototype.toJSON.apply(this,arguments);return e&&e.helpers||(delete t.password,delete t.confirmPassword),t}});return{CheckoutPage:v}}),define("modules/editable-view",["modules/backbone-mozu"],function(e){var t=e.MozuView.extend({constructor:function(){e.MozuView.apply(this,arguments),this.editing={}},getRenderContext:function(){var t=e.MozuView.prototype.getRenderContext.apply(this,arguments);return t.editing=this.editing,t},doModelAction:function(e,t){var i=this,n=function(){i.render()},a=this.model[e](t);return a&&a.then?(a.then(n,n),a):void 0},handleLoadingChange:function(t){e.MozuView.prototype.handleLoadingChange.apply(this,arguments);var i=this.$("input,select,button,textarea");!this.alreadyDisabled&&t?(this.alreadyDisabled=i.filter(":disabled"),i.prop("disabled",!0)):this.alreadyDisabled?(i.not(this.alreadyDisabled).removeProp("disabled"),this.alreadyDisabled=!1):i.removeProp("disabled")}});return t}),define("modules/preserve-element-through-render",["underscore"],function(e){return function(t,i,n){var a={};t._preserved=t._preserved||{},e.each(i,function(e){a[e]=t.$(e)}),n.call(t),e.each(a,function(e,i){var n=t._preserved[i];e.length>0&&(!n||0===n.length)&&(n=t._preserved[i]=e),n&&n.length>0&&t.$(i).replaceWith(n)})}}),define("modules/eventbus",["underscore","backbone"],function(e,t){return e.extend({},t.Events)}),define("modules/amazonpay",["modules/jquery-mozu","modules/eventbus","modules/api","hyprlivecontext","underscore"],function(e,t,i,n,a){function r(e,i){var n="walletWidgetDiv",a={sellerId:e,onPaymentSelect:function(){t.trigger("aws-card-selected")},design:{designMode:"responsive"},onError:function(e){console.log(e.getErrorCode()),console.log(e.getErrorMessage())}};i&&(n="readOnlyWalletWidgetDiv",a.displayMode="Read",a.amazonOrderReferenceId=i),new window.OffAmazonPayments.Widgets.Wallet(a).bind(n)}function o(e,i){var n="amazonAddressBookWidgetDiv",a={sellerId:e,design:{designMode:"responsive"},onOrderReferenceCreate:function(e){var i=e.getAmazonOrderReferenceId();t.trigger("aws-referenceOrder-created",{orderReferenceId:i})},onAddressSelect:function(){},onError:function(e){console.log("AmazonPay widget errorCode: "+e.getErrorCode()),console.log("AmazonPay widget erorMessage: "+e.getErrorMessage())}};i&&(delete a.onOrderReferenceCreate,delete a.onAddressSelect,a.displayMode="Read",a.amazonOrderReferenceId=i),new window.OffAmazonPayments.Widgets.AddressBook(a).bind(n)}var s={sellerId:"",clientId:"",buttonColor:"",buttonType:"",usePopUp:!0,isEnabled:!1,isScriptLoaded:!1,viewName:"amazon-checkout",init:function(i){var r=a.findWhere(n.locals.siteContext.checkoutSettings.externalPaymentWorkflowSettings,{name:"PayWithAmazon"});if(r&&r.isEnabled){this.isEnabled=r.isEnabled;var o=this.getValue(r,"environment"),s="sandbox"==o,d=this.getValue(r,"region");this.sellerId=this.getValue(r,"sellerId"),this.clientId=this.getValue(r,"clientId"),this.buttonColor=this.getValue(r,"buttonColor")||"Gold",this.buttonType=this.getValue(r,"buttonType")||"PwA",this.usePopUp="true"==(this.getValue(r,"usepopup")||"true"),this.billingType=this.getValue(r,"billingAddressOption");var l={de:"eu",uk:"eu",us:"na",jp:"jp"};if(this.sellerId&&this.clientId&&i){var c=this;window.sandbox=s?"/sandbox":"","us"!=d&&(window.sandbox+="/lpa");var u="https://static-"+l[d]+".payments-amazon.com/OffAmazonPayments/"+d+window.sandbox+"/js/Widgets.js";window.onAmazonLoginReady=function(){window.amazon.Login.setClientId(c.clientId)},e.getScript(u).done(function(){c.isScriptLoaded=!0,t.trigger("aws-script-loaded")}).fail(function(e){console.log(e)})}}},getValue:function(e,t){var i=a.findWhere(e.credentials,{apiName:t});if(i)return i.value},addCheckoutButton:function(e,i){var a=this;if(a.isEnabled){var r=n.locals.pageContext.secureHost;r+=i?"/cart?cartId="+e+"&isAwsCheckout=true&view="+a.viewName:"/checkout/"+e+"?isAwsCheckout=true&view="+a.viewName,t.on("aws-script-loaded",function(){var e;window.OffAmazonPayments.Button("AmazonPayButton",a.sellerId,{type:a.buttonType,color:a.buttonColor,useAmazonAddressBook:!0,size:i?"medium":"small",authorization:function(){var t="profile postal_code payments:widget payments:shipping_address";"1"===a.billingType&&(t+=" payments:billing_address");var i={scope:t,popup:a.usePopUp};e=window.amazon.Login.authorize(i,r)},onError:function(e){console.log("AmazonPay widget errorCode: "+e.getErrorCode()),console.log("AmazonPay widget erorMessage: "+e.getErrorMessage())}})})}},addAddressWidget:function(e){o(this.sellerId,e)},addWalletWidget:function(e){r(this.sellerId,e)}};return s}),require(["modules/jquery-mozu","underscore","hyprlive","modules/backbone-mozu","modules/models-checkout","modules/views-messages","modules/cart-monitor","hyprlivecontext","modules/editable-view","modules/preserve-element-through-render","modules/amazonpay","modules/api"],function(e,t,i,n,a,r,o,s,d,l,c,u){var p=d.extend({getExtraVar:function(){return this.model.get("address.countryCode")},edit:function(){var e=this.$el.attr("id");this.model.edit(),"step-shipping-method"==e&&this.$el.children().find('[data-mz-action="next"]').hide()},next:function(){var e=this;e.editing.savedCard=!1,t.defer(function(){e.model.next()})},amazonShippingAndBilling:function(){window.location="/checkout/"+window.order.id+"?isAwsCheckout=true&access_token="+window.order.get("fulfillmentInfo").get("data").addressAuthorizationToken+"&view="+c.viewName},choose:function(){var e=this;e.model.choose.apply(e.model,arguments)},constructor:function(){var e=this;d.apply(this,arguments),e.resize(),setTimeout(function(){e.$(".mz-panel-wrap").css({"overflow-y":"hidden"})},250);try{window.usa_only="",window.nonlow48=["AK","HI","PR","VI","AE","AP","AA"];var n=require.mozuData("checkout").items;n=t.pluck(n,"product"),window.usa_48="",window.usa_only=t.filter(n,function(e){var n=t.where(e.properties,{attributeFQN:i.getThemeSetting("productAttributes").usaOnly});return n.length>0&&n[0].values[0].value?e:void 0}),window.usa_48=t.filter(n,function(e){var n=t.where(e.properties,{attributeFQN:i.getThemeSetting("productAttributes").usa48});return n.length>0&&n[0].values[0].value?e:void 0}),void 0!==this.model.toJSON().address&&("US"!==this.model.toJSON().address.countryCode&&window.usa_only.length>0||"US"!==this.model.toJSON().address.countryCode&&window.usa_48.length>0?e.model.set("address.countryCode","US"):"US"==this.model.toJSON().address.countryCode&&window.usa_48.length>0&&window.nonlow48.indexOf(this.model.toJSON().address.stateOrProvince)>-1&&(e.model.set("address.countryCode","US"),e.model.set("address.stateOrProvince","")))}catch(a){console.log(a)}e.listenTo(e.model,"stepstatuschange",e.render,e),e.$el.on("keypress","input",function(t){return 13===t.which?(e.handleEnterKey(t),!1):void 0})},initStepView:function(){this.model.initStep()},handleEnterKey:function(){this.model.next()},render:function(){if(this.$el.removeClass("is-new is-incomplete is-complete is-invalid").addClass("is-"+this.model.stepStatus()),d.prototype.render.apply(this,arguments),this.resize(),"incomplete"===this.model.stepStatus()||this.$el.hasClass("is-invalid")){var t=this.$el.attr("id").replace(/[^\w\s]/gi,"");window.sessionCamRecorder&&window.sessionCamRecorder.createVirtualPageLoad&&window.sessionCamRecorder.createVirtualPageLoad("/checkout/"+t)}"step-payment-info"==this.$el.attr("id")&&this.$el.hasClass("is-complete")&&e("#step-review").addClass("is-incomplete"),"Add new address"==e("#mz--contactselector-savedcontact option:selected").val()&&e("#shipping-addr-edit-link").hide()},resize:t.debounce(function(){this.$(".mz-panel-wrap").animate({height:this.$(".mz-inner-panel").outerHeight()})},200)}),h=n.MozuView.extend({templateName:"modules/checkout/checkout-order-summary",self:this,initialize:function(){console.log("init order summary "),window.first_load=!0,window.order_obj_win=require.mozuData("checkout").items;var e=this.model.get("fulfillmentInfo.fulfillmentContact.address").toJSON();window.address_obj={cc:e.countryCode,state:e.stateOrProvince,zip:e.postalOrZipCode,ship_code:this.model.get("fulfillmentInfo.shippingMethodCode")},this.listenTo(this.model.get("billingInfo"),"orderPayment",this.onOrderCreditChanged,this)},editCart:function(){window.location="/cart"},events:{"click .toggle_components":"toggleComponets"},toggleComponets:function(t){var i=e(t.currentTarget),n=e(t.target).data("container-id");e('.hide_bundle_products[data-parent-id="'+n+'"]').slideToggle(),i.toggleClass("show_box"),i.hasClass("show_box")?i.html('Hide Components <i class="fa fa-caret-up"></i>'):i.html('Show Components <i class="fa fa-caret-down"></i>')},onOrderCreditChanged:function(){this.render()},render:function(){console.log("render on change"),e(".mz-pagetitle .total_pay strong").text("$"+parseFloat(this.model.get("total")).toFixed(2));var a=window.order.toJSON(),r=this.model.get("fulfillmentInfo.fulfillmentContact.address").toJSON(),o={cc:r.countryCode,state:r.stateOrProvince,zip:r.postalOrZipCode,ship_code:this.model.get("fulfillmentInfo.shippingMethodCode")};if(!t.isEqual(window.address_obj,o)||window.first_load){if("CA"==a.fulfillmentInfo.fulfillmentContact.address.countryCode)this.setOrderDate(this,!1);else if("US"==a.fulfillmentInfo.fulfillmentContact.address.countryCode)"PR"==a.fulfillmentInfo.fulfillmentContact.address.stateOrProvince||"AK"==a.fulfillmentInfo.fulfillmentContact.address.stateOrProvince||"HI"==a.fulfillmentInfo.fulfillmentContact.address.stateOrProvince?this.setOrderDate(this,!1):(console.log("connect to UPS"),this.setOrderDate(this,!0));else{var s=this,d=new Date(e("#time-custom-now").text().replace(/"/g,"")),l=Math.round(+d/1e3),c=d.getHours(),u=new Date;try{e.getJSON("https://maps.googleapis.com/maps/api/timezone/json?location=38.908133,-77.047119&timestamp="+l).done(function(e){if("OK"==e.status){var t=Math.abs(e.rawOffset/60/60),i=e.dstOffset/60/60;u.setDate(d.getDate()),u.setHours(c-(t-i)),console.log(u),u.getHours()>=15&&(15==u.getHours()&&u.getMinutes()<30||u.setDate(u.getDate()+1))}else u.setDate(d.getDate())})}catch(p){console.log("Error on tz "+p),u.setDate(d.getDate())}var h=t.pluck(require.mozuData("holidaylist"),"properties"),m=t.pluck(h,"holiday"),g=require.mozuData("checkout").items,f=t.pluck(g,"product"),v=t.filter(f,function(e){return t.where(e.properties,{attributeFQN:i.getThemeSetting("productAttributes").productionTime}).length>0}),y=t.difference(f,v);v.forEach(function(e){var n=-1,a=0;g.forEach(function(i,a){t.isEqual(i.product,e)&&(n=a)}),s.model.get("items")[n].est_date="No Data",a=t.where(e.properties,{attributeFQN:i.getThemeSetting("productAttributes").productionTime}),a=a[0].values[0].value,s.skip_holidays(u,a+1,m,s.setShippingStartDate,n,s)}),y.forEach(function(e){var i=-1;g.forEach(function(n,a){t.isEqual(n.product,e)&&(i=a)}),s.model.get("items")[i].est_date="No Data",s.skip_holidays(u,1,m,s.setShippingStartDate,i,s)});var C="";t.pluck(window.order.toJSON().items,"est_date").forEach(function(e){C+=e+":::"});var w="";t.pluck(window.order.toJSON().items,"ship_date").forEach(function(e){w+=e+":::"}),this.model.set("orderAttribute-tenant~est-delivery-date",C),this.model.set("orderAttribute-tenant~est-ship-date",w),window.ship_start_str=w,window.ship_est_str=C}window.address_obj=o,window.first_load=!1}else{if(void 0!==window.ship_est_str){for(var b=window.ship_est_str.split(":::"),S=this.model.get("items").length,A=0;S>A;A++)this.model.get("items")[A].est_date=b[A];this.model.set("orderAttribute-tenant~est-delivery-date",window.ship_est_str)}if(void 0!==window.ship_start_str){for(var _=window.ship_start_str.split(":::"),P=this.model.get("items").length,k=0;P>k;k++)this.model.get("items")[k].ship_date=_[k];this.model.set("orderAttribute-tenant~est-ship-date",window.ship_start_str)}}n.MozuView.prototype.render.call(this)},renderCustomAfterShip:function(e){try{var i="";t.pluck(window.order.toJSON().items,"est_date").forEach(function(e){i+=void 0!==e?e+":::":"No Data:::"});var a="";t.pluck(window.order.toJSON().items,"ship_date").forEach(function(e){a+=void 0!==e?e+":::":"No Data:::"}),e.model.set("orderAttribute-tenant~est-delivery-date",i),e.model.set("orderAttribute-tenant~est-ship-date",a),window.ship_est_str=i,window.ship_start_str=a,n.MozuView.prototype.render.call(e)}catch(r){console.log(r),n.MozuView.prototype.render.call(e)}},setOrderDate:function(i,n){{var a=new Date(e("#time-custom-now").attr("date-attr")),r=Math.round(+a/1e3),o=a.getHours(),s=new Date,d=t.pluck(require.mozuData("holidaylist"),"properties");t.pluck(d,"holiday")}try{e.getJSON("https://maps.googleapis.com/maps/api/timezone/json?location=38.908133,-77.047119&timestamp="+r).done(function(e){if("OK"==e.status){var t=Math.abs(e.rawOffset/60/60),r=e.dstOffset/60/60;s.setDate(a.getDate()),s.setMonth(a.getMonth()),s.setFullYear(a.getFullYear()),s.setHours(o-(t-r)),s.setMinutes(a.getMinutes()),console.log(s),i.checkProductionTime(i,n,s)}else i.checkProductionTime(i,n,a)})}catch(l){console.log("Error on tz "+l),i.checkProductionTime(i,n,a)}},checkProductionTime:function(e,n,a){var r=new Date(a),o=[],s=[];r=a.getFullYear()+"/"+("0"+(a.getMonth()+1)).slice(-2)+"/"+("0"+a.getDate()).slice(-2);var d=window.order_obj_win,l=t.pluck(d,"product"),c=t.filter(l,function(e){return t.where(e.properties,{attributeFQN:i.getThemeSetting("productAttributes").productionTime}).length>0});l.forEach(function(e){if("Standard"===e.productUsage&&e.options.length>1&&(c.push(e),e.bundledProducts.length>0&&void 0===o[e.bundledProducts[0].productCode])){var t=e.bundledProducts[0].productCode;o[t]=0,s.push(t)}}),console.log("ext_product_time"),console.log(c),e.getExtraProductType(o,c,0,s,e,r,n)},getExtraProductType:function(e,n,a,r,o,s,d){if(0===r.length)o.startProductShiping(n,s,d,o,e);else try{u.request("GET","/api/commerce/catalog/storefront/products/"+r[a]+"?responseFields=properties,productCode").then(function(l){var c=l.productCode,u=l.productCode+"_zipcd",p=c+"_melt",h=t.where(l.properties,{attributeFQN:i.getThemeSetting("productAttributes").productionTime}),m=t.where(l.properties,{attributeFQN:i.getThemeSetting("productAttributes").shipZip}),g=t.findWhere(l.properties,{attributeFQN:i.getThemeSetting("productAttributes").productMelt});h.length>0&&(e[c]=h[0].values[0].value),m.length>0&&(console.log(u+" -- "+m[0].values[0].stringValue),window.zipArr[u]=m[0].values[0].stringValue),void 0!==g&&g.values[0].value&&(window.meltArr[p]=g.values[0].value,console.log("melt "+c)),a++,a<r.length?o.getExtraProductType(e,n,a,r,o,s,d):o.startProductShiping(n,s,d,o,e)},function(){a++,a<r.length?o.getExtraProductType(e,n,a,r,o,s,d):o.startProductShiping(n,s,d,o,e)})}catch(l){console.log("Error on getExtraProductType "+l),o.startProductShiping(n,s,d,o,e)}},startProductShiping:function(e,n,a,r,o){var s=window.order_obj_win,d=t.pluck(s,"product"),l=t.pluck(require.mozuData("holidaylist"),"properties"),c=t.pluck(l,"holiday"),u=this,p=[],h=1,m=0,g=!1;window.indina_idx_arr=[],d.forEach(function(e,n){var a=t.findWhere(e.properties,{attributeFQN:i.getThemeSetting("productAttributes").shipZip}),r=t.findWhere(e.properties,{attributeFQN:i.getThemeSetting("productAttributes").productionTime}),s=t.findWhere(e.properties,{attributeFQN:i.getThemeSetting("productAttributes").productMelt});if(r=void 0===r?e.bundledProducts.length>0?void 0!==o[e.bundledProducts[0].productCode]?o[e.bundledProducts[0].productCode]:1:1:r.values.length>0?r.values[0].value:1,void 0!==a)"46787"===a.values[0].stringValue&&(p.push(e),window.indina_idx_arr.push(n),r>=h&&(h=r,m=n));else if(e.bundledProducts.length>0){var d=e.bundledProducts[0].productCode+"_zipcd";if(void 0!==window.zipArr[d]){var l=window.zipArr[d];"46787"===l&&(p.push(e),window.indina_idx_arr.push(n),r>=h&&(h=r,m=n))}else p.push(e),window.indina_idx_arr.push(n),r>=h&&(h=r,m=n)}else p.push(e),window.indina_idx_arr.push(n),r>=h&&(h=r,m=n);if(void 0!==s){if(s.values[0].value===!0&&window.indina_idx_arr.indexOf(n)>=0)g=!0;else if(e.bundledProducts.length>0){var c=e.bundledProducts[0].productCode+"_melt";void 0!==window.meltArr[c]&&window.indina_idx_arr.indexOf(n)>=0&&(g=!0)}}else if(e.bundledProducts.length>0){var u=e.bundledProducts[0].productCode+"_melt";void 0!==window.meltArr[u]&&window.indina_idx_arr.indexOf(n)>=0&&(g=!0)}});var f=t.difference(d,p),v=t.difference(e,p),y=t.difference(f,v);if(a){window.indina_idx_arr.length>0&&u.skip_holidays(n,h,c,function(e){g&&(e.getDay()>=4||0===e.getDay())?r.get_meltPackage_start(e,c,r,m):(r.UPSWebEstimate(e,m,c,r,!1,!0),window.indina_idx_arr.forEach(function(t){r.model.get("items")[t].ship_date=("0"+(e.getMonth()+1)).slice(-2)+"/"+("0"+e.getDate()).slice(-2)+"/"+e.getFullYear()}))},m,r);var C=[];y.forEach(function(e){var a=-1;s.forEach(function(i,n){t.isEqual(i.product,e)&&-1===a&&C.indexOf(n)<0&&(a=n,C.push(a))});var o=t.findWhere(r.model.get("items")[a].product.properties,{attributeFQN:i.getThemeSetting("productAttributes").productMelt}),d=new Date(n);if(void 0!==o)if(o.values[0].value&&(d.getDay()>=4||0===d.getDay()))r.est_date_usa(d,a,c,r);else if(r.model.get("items")[a].product.bundledProducts.length>0){var l=r.model.get("items")[a].product.bundledProducts[0].productCode+"_melt";void 0!==window.meltArr[l]&&(d.getDay()>=3||0===d.getDay())?r.est_date_usa(d,a,c,r):r.UPSWebEstimate(d,a,c,r,!0)}else r.UPSWebEstimate(d,a,c,r,!0);else if(r.model.get("items")[a].product.bundledProducts.length>0){var u=r.model.get("items")[a].product.bundledProducts[0].productCode+"_melt";void 0!==window.meltArr[u]&&(d.getDay()>=3||0===d.getDay())?r.est_date_usa(d,a,c,r):r.UPSWebEstimate(d,a,c,r,!0)}else r.UPSWebEstimate(d,a,c,r,!0)});var w=[];v.forEach(function(e){var a=-1,d=0;s.forEach(function(i,n){t.isEqual(i.product,e)&&-1===a&&w.indexOf(n)<0&&(a=n,w.push(a))}),d=t.where(e.properties,{attributeFQN:i.getThemeSetting("productAttributes").productionTime}),d=d.length>0?d[0].values[0].value:void 0!==o[e.bundledProducts[0].productCode]?o[e.bundledProducts[0].productCode]:0,u.est_shipping_start_date(n,a,d,c,r,!0)})}else{window.indina_idx_arr.length>0&&u.skip_holidays(n,h,c,function(e){e.getDay()<4?r.setCA_ship_start(e,c,r,m,!0):u.final_shipping_end(e,m,c,r,!1,!0)},m,r);var b=[];y.forEach(function(e){var i=-1;s.forEach(function(n,a){t.isEqual(n.product,e)&&-1===i&&b.indexOf(a)<0&&(i=a,b.push(i))}),u.skip_holidays(n,1,c,function(e){e.getDay()<4?r.setCA_ship_start(e,c,r,i):u.final_shipping_end(e,i,c,r,!1,!1)},i,r)});var S=[];v.forEach(function(e){var a=-1,d=0;s.forEach(function(i,n){t.isEqual(i.product,e)&&-1===a&&S.indexOf(n)<0&&(a=n,S.push(a))}),d=t.where(e.properties,{attributeFQN:i.getThemeSetting("productAttributes").productionTime}),d=d.length>0?d[0].values[0].value:void 0!==o[e.bundledProducts[0].productCode]?o[e.bundledProducts[0].productCode]:0;var l=t.findWhere(e.properties,{attributeFQN:i.getThemeSetting("productAttributes").shipZip});if(void 0===l&&r.model.get("items")[a].product.bundledProducts.length>0){var p=r.model.get("items")[a].product.bundledProducts[0].productCode+"_zipcd";void 0!==window.zipArr[p]&&(l=window.zipArr[p],window.order.get("items")[a].zipcode=l)}0===d&&(d=1),u.skip_holidays(n,d,c,function(e){e.getDay()<4?r.setCA_ship_start(e,c,r,a):u.final_shipping_end(e,a,c,r,!1,!1)},a,r)})}},est_shipping_start_date:function(e,n,a,r,o,s){if(s){var d=t.findWhere(o.model.get("items")[n].product.properties,{attributeFQN:i.getThemeSetting("productAttributes").productMelt});if(void 0!==d){{new Date(e)}o.skip_holidays(e,a,r,function(t,i,n,o){if(d.values[0].value&&(t.getDay()>=3||0===t.getDay()))o.est_date_usa(t,i,n,o);else if(o.model.get("items")[i].product.bundledProducts.length>0){var s=o.model.get("items")[i].product.bundledProducts[0].productCode+"_melt";void 0!==window.meltArr[s]&&(t.getDay()>=3||0===t.getDay())?o.skip_holidays(t,1,r,o.est_date_usa,i,o):0===a?o.UPSWebEstimate(t,i,r,o,!0):o.skip_holidays(e,a,r,function(e,t,i,n){n.UPSWebEstimate(e,t,i,n,!1)},i,o)}else if(o.model.get("items")[i].product.bundledProducts.length>0){var l=o.model.get("items")[i].product.bundledProducts[0].productCode+"_melt";void 0!==window.meltArr[l]?o.skip_holidays(t,1,r,o.est_date_usa,i,o):0===a?o.UPSWebEstimate(t,i,r,o,!0):o.skip_holidays(e,a,r,function(e,t,i,n){n.UPSWebEstimate(e,t,i,n,!1)},i,o)}else 0===a?o.UPSWebEstimate(t,i,r,o,!0):o.skip_holidays(e,a,r,function(e,t,i,n){n.UPSWebEstimate(e,t,i,n,!1)},i,o)},n,o)}else if(o.model.get("items")[n].product.bundledProducts.length>0){var l=o.model.get("items")[n].product.bundledProducts[0].productCode+"_melt";void 0!==window.meltArr[l]?o.skip_holidays(e,a,r,function(e,t,i,n){n.skip_holidays(e,1,r,n.est_date_usa,t,n)},n,o):0===a?o.skip_holidays(e,1,r,o.UPSWebEstimate,n,o):o.skip_holidays(e,a,r,o.UPSWebEstimate,n,o)}else 0===a?o.skip_holidays(e,1,r,o.UPSWebEstimate,n,o):o.skip_holidays(e,a,r,o.UPSWebEstimate,n,o)}},setShippingStartDate:function(e,t,i,n){n.model.get("items")[t].ship_date=("0"+(e.getMonth()+1)).slice(-2)+"/"+("0"+e.getDate()).slice(-2)+"/"+e.getFullYear()},final_shipping_end:function(e,i,n,a,r,o){{var s;new Date(e)}if(s=t.pluck(require.mozuData("shipBusDate"),"properties"),s=t.findWhere(s,{ship_code:a.model.toJSON().fulfillmentInfo.shippingMethodCode}),console.log("shipping start date "+new Date(e).toISOString().slice(0,10)),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0!==s&&(s=s.no_business_day),r){if(a.skip_holidays(e,1,n,a.setShippingStartDate,i,a),void 0!==s)a.skip_holidays(e,s,n,function(t){if(a.model.get("items")[i].est_date=("0"+(t.getMonth()+1)).slice(-2)+"/"+("0"+t.getDate()).slice(-2)+"/"+t.getFullYear(),o){var n=("0"+(t.getMonth()+1)).slice(-2)+"/"+("0"+t.getDate()).slice(-2)+"/"+t.getFullYear(),r=("0"+(e.getMonth()+1)).slice(-2)+"/"+("0"+e.getDate()).slice(-2)+"/"+e.getFullYear();window.indina_idx_arr.forEach(function(e){a.model.get("items")[e].est_date=n,a.model.get("items")[e].ship_date=r})}},i,a);else if(a.model.get("items")[i].est_date="No Data",o){var d=("0"+(e.getMonth()+1)).slice(-2)+"/"+("0"+e.getDate()).slice(-2)+"/"+e.getFullYear();window.indina_idx_arr.forEach(function(e){a.model.get("items")[e].est_date="No Data",a.model.get("items")[e].ship_date=d})}a.renderCustomAfterShip(a)}else{if(a.setShippingStartDate(new Date(e),i,n,a),void 0!==s)a.skip_holidays(e,s-1,n,function(t){if(console.log("Final Arrival Date "+t.toISOString().slice(0,10)),a.model.get("items")[i].est_date=("0"+(t.getMonth()+1)).slice(-2)+"/"+("0"+t.getDate()).slice(-2)+"/"+t.getFullYear(),o){var n=("0"+(t.getMonth()+1)).slice(-2)+"/"+("0"+t.getDate()).slice(-2)+"/"+t.getFullYear(),r=("0"+(e.getMonth()+1)).slice(-2)+"/"+("0"+e.getDate()).slice(-2)+"/"+e.getFullYear();window.indina_idx_arr.forEach(function(e){a.model.get("items")[e].est_date=n,a.model.get("items")[e].ship_date=r})}},i,a);else if(a.model.get("items")[i].est_date="No Data",o){var l=("0"+(e.getMonth()+1)).slice(-2)+"/"+("0"+e.getDate()).slice(-2)+"/"+e.getFullYear();window.indina_idx_arr.forEach(function(e){a.model.get("items")[e].est_date="No Data",a.model.get("items")[e].ship_date=l})}a.renderCustomAfterShip(a)}},skip_holidays:function(e,t,i,n,a,r){if(1>t)return n(new Date(e),a,i,r),!0;for(var o=new Date(e),s=0;t>s;)o.setDate(o.getDate()+1),o.getDay()<6&&0!==o.getDay()&&-1==i.indexOf(o.getFullYear()+"-"+("0"+(o.getMonth()+1)).slice(-2)+"-"+("0"+o.getDate()).slice(-2))&&++s;o.setDate(o.getDate()),n(o,a,i,r)},setCA_ship_start:function(e,t,i,n,a){var r,o=new Date(e);o.getDay()<4&&(r=4-o.getDay(),i.skip_holidays(o,r,t,function(e){var r=new Date(e);if(r.getDay()<4)i.setCA_ship_start(r,t,i,n,a);else if(i.final_shipping_end(r,n,t,i,!1,a),a){var o=("0"+(r.getMonth()+1)).slice(-2)+"/"+("0"+r.getDate()).slice(-2)+"/"+r.getFullYear();window.indina_idx_arr.forEach(function(e){i.model.get("items")[e].ship_date=o})}},n,i))},get_meltPackage_start:function(e,t,i,n){var a,r=new Date(e);r.getDay()>=4?(a=1,i.skip_holidays(r,a,t,function(e){var a=new Date(e);a.getDay()>=4?i.get_meltPackage_start(a,t,i,n):(i.UPSWebEstimate(a,n,t,i,!1,!0),window.indina_idx_arr.forEach(function(e){i.model.get("items")[e].ship_date=("0"+(a.getMonth()+1)).slice(-2)+"/"+("0"+a.getDate()).slice(-2)+"/"+a.getFullYear()}))})):0===r.getDay()?i.skip_holidays(e,1,t,function(e){var a=new Date(e);a.getDay()>=4?i.get_meltPackage_start(a,t,i,n):(i.UPSWebEstimate(a,n,t,i,!1,!0),window.indina_idx_arr.forEach(function(e){i.model.get("items")[e].ship_date=("0"+(a.getMonth()+1)).slice(-2)+"/"+("0"+a.getDate()).slice(-2)+"/"+a.getFullYear()}))}):i.skip_holidays(e,1,t,function(e){i.UPSWebEstimate(e,n,t,i,!1,!0),window.indina_idx_arr.forEach(function(t){i.model.get("items")[t].ship_date=("0"+(e.getMonth()+1)).slice(-2)+"/"+("0"+e.getDate()).slice(-2)+"/"+e.getFullYear()})})},est_date_usa:function(e,t,i,n){var a,r=new Date(e);r.getDay()>=4?(a=1,n.skip_holidays(r,a,i,function(e){var a=new Date(e);a.getDay()>=4?n.est_date_usa(a,t,i,n):n.UPSWebEstimate(a,t,i,n,!1)})):0===r.getDay()?n.skip_holidays(r,1,i,function(e){var a=new Date(e);a.getDay()>=4?n.est_date_usa(a,t,i,n):n.UPSWebEstimate(a,t,i,n,!1)}):(n.model.get("items")[t].est_date="No Data",n.skip_holidays(r,1,i,n.setShippingStartDate,t,n))},UPSWebEstimate:function(n,a,r,o,s,d){var l=o.model.toJSON().fulfillmentInfo.fulfillmentContact.address,c=t.findWhere(o.model.get("items")[a].product.properties,{attributeFQN:i.getThemeSetting("productAttributes").shipZip});if(void 0!==c)c=c.values[0].stringValue;else if(o.model.get("items")[a].product.bundledProducts.length>0){var u=o.model.get("items")[a].product.bundledProducts[0].productCode+"_zipcd";void 0!==window.zipArr[u]?(c=window.zipArr[u],window.order.get("items")[a].zipcode=c):c="46787"}else c="46787";var p="?spc="+c+"&dst="+l.stateOrProvince+"&dct="+l.cityOrTown+"&dpc="+l.postalOrZipCode;if(s)o.skip_holidays(n,1,r,function(i,n,a,r){var o=i.getFullYear()+"/"+("0"+(i.getMonth()+1)).slice(-2)+"/"+("0"+i.getDate()).slice(-2);p+="&sdate="+o.replace(/\//g,""),console.log(p),e.ajax({async:!0,url:"/ups-route-custom"+p,method:"GET",headers:{"content-type":"application/json"},error:function(){r.model.get("items")[n].est_date="No Data",r.setShippingStartDate(i,n,a,r),r.renderCustomAfterShip(r)},success:function(e){try{if(void 0!==e.TimeInTransitResponse.TransitResponse){var o=e.TimeInTransitResponse.TransitResponse.ServiceSummary,s=t.pluck(require.mozuData("shipBusDate"),"properties");s=t.findWhere(s,{ship_code:r.model.toJSON().fulfillmentInfo.shippingMethodCode}),o=t.filter(o,function(e){return e.Service.Code==s.no_business_day
});var d=new Date(o[0].EstimatedArrival.Arrival.Date.slice(0,4)+"/"+o[0].EstimatedArrival.Arrival.Date.slice(4,6)+"/"+o[0].EstimatedArrival.Arrival.Date.slice(6,9));if("GND"===s.no_business_day){r.setShippingStartDate(i,n,a,r);var l=t.pluck(require.mozuData("shipUPSDate"),"properties"),c=t.pluck(l,"holiday");r.skip_holidays(d,1,c,r.endUPSShipping,n,r)}else r.setShippingStartDate(i,n,a,r),r.model.get("items")[n].est_date=("0"+(d.getMonth()+1)).slice(-2)+"/"+("0"+d.getDate()).slice(-2)+"/"+d.getFullYear(),r.renderCustomAfterShip(r)}else r.model.get("items")[n].est_date="No Data",r.setShippingStartDate(i,n,a,r),r.renderCustomAfterShip(r)}catch(u){r.model.get("items")[n].est_date="No Data",r.setShippingStartDate(i,n,a,r),r.renderCustomAfterShip(r)}}})},a,o);else{var h=n.getFullYear()+"/"+("0"+(n.getMonth()+1)).slice(-2)+"/"+("0"+n.getDate()).slice(-2);p+="&sdate="+h.replace(/\//g,""),console.log(p),e.ajax({async:!0,url:"/ups-route-custom"+p,method:"GET",headers:{"content-type":"application/json"},error:function(){if(o.model.get("items")[a].est_date="No Data",d){var e=("0"+(n.getMonth()+1)).slice(-2)+"/"+("0"+n.getDate()).slice(-2)+"/"+n.getFullYear();window.indina_idx_arr.forEach(function(t){o.model.get("items")[t].ship_date=e})}else o.setShippingStartDate(n,a,r,o);o.renderCustomAfterShip(o)},success:function(e){console.log("Done..!");try{if(void 0!==e.TimeInTransitResponse.TransitResponse){var i=e.TimeInTransitResponse.TransitResponse.ServiceSummary,s=t.pluck(require.mozuData("shipBusDate"),"properties");s=t.findWhere(s,{ship_code:o.model.toJSON().fulfillmentInfo.shippingMethodCode}),i=t.filter(i,function(e){return e.Service.Code==s.no_business_day});var l=new Date(i[0].EstimatedArrival.Arrival.Date.slice(0,4)+"/"+i[0].EstimatedArrival.Arrival.Date.slice(4,6)+"/"+i[0].EstimatedArrival.Arrival.Date.slice(6,9));if("GND"===s.no_business_day){o.setShippingStartDate(n,a,r,o);var c=t.pluck(require.mozuData("shipUPSDate"),"properties"),u=t.pluck(c,"holiday");d?(o.skip_holidays(l,1,u,function(e){var t=("0"+(n.getMonth()+1)).slice(-2)+"/"+("0"+n.getDate()).slice(-2)+"/"+n.getFullYear();window.indina_idx_arr.forEach(function(i){o.model.get("items")[i].ship_date=t,o.model.get("items")[i].est_date=("0"+(e.getMonth()+1)).slice(-2)+"/"+("0"+e.getDate()).slice(-2)+"/"+e.getFullYear()})},a,o),o.renderCustomAfterShip(o)):o.skip_holidays(l,1,u,o.endUPSShipping,a,o)}else o.setShippingStartDate(n,a,r,o),o.model.get("items")[a].est_date=("0"+(l.getMonth()+1)).slice(-2)+"/"+("0"+l.getDate()).slice(-2)+"/"+l.getFullYear(),d&&window.indina_idx_arr.forEach(function(e){o.model.get("items")[e].est_date=("0"+(l.getMonth()+1)).slice(-2)+"/"+("0"+l.getDate()).slice(-2)+"/"+l.getFullYear()}),o.renderCustomAfterShip(o)}else o.model.get("items")[a].est_date="No Data",o.setShippingStartDate(n,a,r,o),o.renderCustomAfterShip(o)}catch(p){console.log("error "),console.log(p),o.model.get("items")[a].est_date="No Data",o.setShippingStartDate(n,a,r,o),o.renderCustomAfterShip(o)}}})}},endUPSShipping:function(e,t,i,n){n.model.get("items")[t].est_date=("0"+(e.getMonth()+1)).slice(-2)+"/"+("0"+e.getDate()).slice(-2)+"/"+e.getFullYear(),n.renderCustomAfterShip(n)},handleLoadingChange:function(){}}),m=p.extend({templateName:"modules/checkout/step-shipping-address",isAddressEditing:"0",autoUpdate:["firstName","lastNameOrSurname","address.address1","address.address2","address.address3","address.cityOrTown","address.countryCode","address.stateOrProvince","address.postalOrZipCode","address.addressType","phoneNumbers.home","contactId","email"],renderOnChange:["address.countryCode","contactId"],additionalEvents:{"click a#shipping-addr-edit-link":"updateAddressEditingProperty"},updateAddressEditingProperty:function(){this.model.set("isAddressEditing","1"),this.render()},beginAddContact:function(){this.model.set("contactId","new")},next:function(){this.validateShipItem(this)},validateShipItem:function(i){var n=i;try{var a="<ul class='is-showing mz-errors'>";"US"!==this.model.toJSON().address.countryCode&&window.usa_only.length>0||"US"!==this.model.toJSON().address.countryCode&&window.usa_48.length>0?(a+="<li class='mz-error-item'>You have items that can only ship to an address in the USA</li>",window.usa_only.forEach(function(e){a+="<li class='mz-error-item'><strong>"+e.name+"</strong></li>"}),window.usa_48.forEach(function(e){a+="<li class='mz-error-item'><strong>"+e.name+"</strong></li>"}),a+="<li>Please remove these items from your cart or change your ship to address</li></ul>",e(".mz-messagebar").html(a),e("html, body").animate({scrollTop:0},"slow")):"US"==this.model.toJSON().address.countryCode&&window.usa_48.length>0&&window.nonlow48.indexOf(this.model.toJSON().address.stateOrProvince)>-1?(a+="<li class='mz-error-item'>You have items that can only ship to an address in the Contiguous U.S.</li>",window.usa_48.forEach(function(e){a+="<li class='mz-error-item'><strong>"+e.name+"</strong></li>"}),a+="<li>Please remove these items from your cart or change your ship to address</li></ul>",e(".mz-messagebar").html(a),e("html, body").animate({scrollTop:0},"slow")):(n.editing.savedCard=!1,this.model.set("isAddressEditing","0"),t.defer(function(){n.model.next()}))}catch(r){n.editing.savedCard=!1,this.model.set("isAddressEditing","0"),t.defer(function(){n.model.next()})}}}),g=p.extend({templateName:"modules/checkout/step-shipping-method",renderOnChange:["availableShippingMethods"],render:function(){try{var e=require.mozuData("checkout").items;if(window.ground_only="",e=t.pluck(e,"product"),window.ground_only=t.filter(e,function(e){var n=t.where(e.properties,{attributeFQN:i.getThemeSetting("productAttributes").groundOnly});return n.length>0&&n[0].values[0].value?e:void 0}),window.ground_only.length>0&&"US"===this.model.toJSON().fulfillmentContact.address.countryCode){var n=t.where(this.model.get("availableShippingMethods"),{shippingMethodCode:"24"});n.length>0&&this.model.set("availableShippingMethods",n)}}catch(a){console.log("Error On render"),console.log(a)}p.prototype.render.apply(this)},additionalEvents:{"change [data-mz-shipping-method]":"updateShippingMethod"},updateShippingMethod:function(){this.model.updateShippingMethod(this.$("[data-mz-shipping-method]:checked").val())}}),f=function(){var e=[],t=s.locals.siteContext.checkoutSettings.purchaseOrder&&s.locals.siteContext.checkoutSettings.purchaseOrder.isEnabled;if(t){var i=s.locals.siteContext.checkoutSettings.purchaseOrder.customFields;i.forEach(function(t){t.isEnabled&&e.push("purchaseOrder.pOCustomField-"+t.code)},this)}return e},v=s.locals.siteContext.checkoutSettings.visaCheckout,y=require.mozuData("pagecontext"),C=p.extend({templateName:"modules/checkout/step-payment-info",autoUpdate:["savedPaymentMethodId","paymentType","card.paymentOrCardType","card.cardNumberPartOrMask","card.nameOnCard","card.expireMonth","card.expireYear","card.cvv","card.isCardInfoSaved","check.nameOnCheck","check.routingNumber","check.checkNumber","isSameBillingShippingAddress","billingContact.firstName","billingContact.lastNameOrSurname","billingContact.address.address1","billingContact.address.address2","billingContact.address.address3","billingContact.address.cityOrTown","billingContact.address.countryCode","billingContact.address.stateOrProvince","billingContact.address.postalOrZipCode","billingContact.phoneNumbers.home","billingContact.email","creditAmountToApply","digitalCreditCode","purchaseOrder.purchaseOrderNumber","purchaseOrder.paymentTerm"].concat(f()),renderOnChange:["billingContact.address.countryCode","paymentType","isSameBillingShippingAddress","usingSavedCard","savedPaymentMethodId"],additionalEvents:{"change [data-mz-digital-credit-enable]":"enableDigitalCredit","change [data-mz-digital-credit-amount]":"applyDigitalCredit","change [data-mz-digital-add-remainder-to-customer]":"addRemainderToCustomer","change [name='paymentType']":"resetPaymentData","change [data-mz-purchase-order-payment-term]":"updatePurchaseOrderPaymentTerm","keyup [data-mz-value='card.cardNumberPartOrMask']":"setCardType","change [data-mz-value='card.expireMonth']":"showSaveCardOption","change [data-mz-value='card.expireYear']":"showSaveCardOption"},showSaveCardOption:function(){require.mozuData("user").isAuthenticated&&e(".mz-payment-credit-card-savepayment-row").css("display","block")},setCardType:function(){for(var t=e('[data-mz-value="card.cardNumberPartOrMask"]').val().trim(),i="",n=[{name:"visa",pattern:/^4/,valid_length:[16]},{name:"amex",pattern:/^3[47]/,valid_length:[15]},{name:"mastercard",pattern:/^5[1-5]/,valid_length:[16]},{name:"discover",pattern:/^(6011|622(12[6-9]|1[3-9][0-9]|[2-8][0-9]{2}|9[0-1][0-9]|92[0-5]|64[4-9])|65)/,valid_length:[16]}],a=0;a<n.length;a++)n[a].pattern.test(t)&&(i=n[a].name);switch(i){case"visa":e(".selected-card-icon").html('<img src="../resources/images/Visa.svg?">'),e('select#mz-payment-credit-card-type option[value="VISA"]').attr("selected","selected"),this.model.set("card.paymentOrCardType","VISA");break;case"amex":e(".selected-card-icon").html('<img src="../resources/images/Amex.svg"/>'),e('select#mz-payment-credit-card-type option[value="AMEX"]').attr("selected","selected"),this.model.set("card.paymentOrCardType","AMEX");break;case"mastercard":e(".selected-card-icon").html('<img src="../resources/images/Mastercard.svg"/>'),e('select#mz-payment-credit-card-type option[value="MC"]').attr("selected","selected"),this.model.set("card.paymentOrCardType","MC");break;case"discover":e(".selected-card-icon").html('<img src="../resources/images/Discover.svg"/>'),e('select#mz-payment-credit-card-type option[value="DISCOVER"]').attr("selected","selected"),this.model.set("card.paymentOrCardType","DISCOVER");break;default:e(".selected-card-icon").html('<i class="fa fa-2x fa-credit-card"></i>'),e("select#mz-payment-credit-card-type option").removeAttr("selected"),t.length>3?(e('[data-mz-validationmessage-for="card.cardNumberPartOrMask"]').text("Card invalid. We support Visa, Amex, Master card, Discover"),setTimeout(function(){e('[data-mz-validationmessage-for="card.cardNumberPartOrMask"]').text("")},5e3)):e('[data-mz-validationmessage-for="card.cardNumberPartOrMask"]').text("")}require.mozuData("user").isAuthenticated&&e(".mz-payment-credit-card-savepayment-row").css("display","block"),this.model.set("card.nameOnCard",this.model.get("billingContact.firstName")+" "+this.model.get("billingContact.lastNameOrSurname"))},initialize:function(){this.listenTo(this.model,"change:digitalCreditCode",this.onEnterDigitalCreditCode,this),this.listenTo(this.model,"orderPayment",function(){this.render()},this),this.listenTo(this.model,"change:savedPaymentMethodId",function(){e("[data-mz-saved-cvv]").val("").change(),this.render()},this),this.codeEntered=!!this.model.get("digitalCreditCode"),this.listenTo(this.model,"removeAmazonPayment",function(){e("#changeAwsAddress").hide(),e("#addressEdit").show()})},resetPaymentData:function(){this.model.unset("card.cardNumberPartOrMask"),this.model.unset("card.expireMonth"),this.model.unset("card.expireYear")},updatePurchaseOrderPaymentTerm:function(e){this.model.setPurchaseOrderPaymentTerm(e.target.value)},render:function(){console.log("render"),this.model.set("card.CCSaveFlag",e("select.mz-payment-select-saved-payments").val()),l(this,[".v-button",".p-button","#amazonButonPaymentSection"],function(){p.prototype.render.apply(this,arguments)});this.model.stepStatus();e("#AmazonPayButton").length>0&&e("#amazonButonPaymentSection").length>0&&e("#AmazonPayButton").removeAttr("style").appendTo("#amazonButonPaymentSection"),v.isEnabled&&!this.visaCheckoutInitialized&&this.$(".v-button").length>0&&(window.onVisaCheckoutReady=t.bind(this.initVisaCheckout,this),require([y.visaCheckoutJavaScriptSdkUrl]),this.visaCheckoutInitialized=!0),this.setQuotePaymentData();var i=new Date,n=(e(".mz-payment-select-saved-payments option:selected").val(),e("#mz-payment-expiration-year")),a=i.getFullYear(),r=0;this.model.get("card")&&(r=this.model.get("card").get("expireYear"));for(var o="",s=a;a+15>=s;s++){var d="";r==s&&(d="selected"),o+="<option "+d+' val="'+s+'">'+s+"</option>"}e(n).append(o)},setQuotePaymentData:function(){var t=e("[data-mz-payment-type]:checked").val();"Check"===t&&(this.model.set({"check.nameOnCheck":"Quote Order"}),this.model.set({"check.routingNumber":"1111111111"}),this.model.set({"check.checkNumber":"2222222222"}))},updateAcceptsMarketing:function(t){this.model.getOrder().set("acceptsMarketing",e(t.currentTarget).prop("checked"))},updatePaymentType:function(t){var i=e(t.currentTarget).val();this.model.set("usingSavedCard",t.currentTarget.hasAttribute("data-mz-saved-credit-card")),this.model.set("paymentType",i)},beginEditingCard:function(){this.model.isExternalCheckoutFlowComplete()||(this.editing.savedCard=!0,this.render())},beginEditingExternalPayment:function(){var e=this;this.model.isExternalCheckoutFlowComplete()&&this.doModelAction("cancelExternalCheckout").then(function(){e.editing.savedCard=!0,e.render()})},beginEditingBillingAddress:function(){this.editing.savedBillingAddress=!0,this.render()},beginApplyCredit:function(){this.model.beginApplyCredit(),this.render()},cancelApplyCredit:function(){this.model.closeApplyCredit(),this.render()},cancelExternalCheckout:function(){var e=this;this.doModelAction("cancelExternalCheckout").then(function(){e.editing.savedCard=!1,e.render()})},finishApplyCredit:function(){var e=this;this.model.finishApplyCredit().then(function(){e.render()})},removeCredit:function(t){var i=this,n=e(t.currentTarget).data("mzCreditId");this.model.removeCredit(n).then(function(){i.render()})},getDigitalCredit:function(){var e=this;this.$el.addClass("is-loading"),this.model.getDigitalCredit().ensure(function(){e.$el.removeClass("is-loading")})},stripNonNumericAndParseFloat:function(e){if(!e)return 0;var t=parseFloat(e.replace(/[^\d\.]/g,""));return isNaN(t)?0:t},applyDigitalCredit:function(t){var i=e(t.currentTarget).prop("value"),n=e(t.currentTarget).attr("data-mz-credit-code-target");if(n){var a=this.stripNonNumericAndParseFloat(i);this.model.applyDigitalCredit(n,a,!0),this.render()}},onEnterDigitalCreditCode:function(e,t){t&&!this.codeEntered&&(this.codeEntered=!0,this.$el.find("button").prop("disabled",!1)),!t&&this.codeEntered&&(this.codeEntered=!1,this.$el.find("button").prop("disabled",!0))},enableDigitalCredit:function(t){var i=e(t.currentTarget).attr("data-mz-credit-code-source"),n=e(t.currentTarget).prop("checked")===!0,a=this.$el.find("input[data-mz-credit-code-target='"+i+"']"),r=this;n?(a.prop("disabled",!1),r.model.applyDigitalCredit(i,null,!0)):(a.prop("disabled",!0),r.model.applyDigitalCredit(i,0,!1),r.render())},addRemainderToCustomer:function(t){var i=e(t.currentTarget).attr("data-mz-credit-code-to-tie-to-customer"),n=e(t.currentTarget).prop("checked")===!0;this.model.addRemainingCreditToCustomerAccount(i,n)},handleEnterKey:function(t){var i=e(t.currentTarget).attr("data-mz-value");if(i)switch(i){case"creditAmountApplied":return this.applyDigitalCredit(t);case"digitalCreditCode":return this.getDigitalCredit(t)}},initVisaCheckout:function(){var e=this,t=s.locals.siteContext.checkoutSettings.visaCheckout,i=t.apiKey||"0H1JJQFW9MUVTXPU5EFD13fucnCWg42uLzRQMIPHHNEuQLyYk",n=t.clientId||"mozu_test1",a=this.model.getOrder();return window.V?(window.V.on("payment.success",function(t){e.editing.savedCard=!1,e.model.parent.processDigitalWallet("VisaCheckout",t)}),window.V.init({apikey:i,clientId:n,paymentRequest:{currencyCode:a.get("currencyCode"),subtotal:""+a.get("subtotal")}}),void 0):!1}}),w=n.MozuView.extend({templateName:"modules/checkout/coupon-code-field",couponsData:{},handleLoadingChange:function(){},additionalEvents:{"click a.remove-coupon-link":"removeCoupon"},initialize:function(){var i=this;this.listenTo(this.model,"change:couponCode",this.onEnterCouponCode,this),this.codeEntered=!!this.model.get("couponCode"),this.$el.on("keypress","input",function(e){return 13===e.which?(i.codeEntered&&i.handleEnterKey(),!1):void 0});var n=e.cookie("coupon"),a={};"undefined"!=typeof n&&(a=e.parseJSON(n));var r=this.model.get("couponCodes"),o=(this.model.id,e.cookie("coupon"));if(o&&""!==o&&(i.couponsData=JSON.parse(o)),Object.keys(a).length>=r.length){var s=[];if(Object.keys(a).forEach(function(e){a[e]&&t.indexOf(r,e)>-1&&s.push(e)}),s.length>1){var d=t.rest(s,[1]);d.forEach(function(e){try{i.couponsData[e]=!1;i.model.apiRemoveCoupon(e).then(function(){})}catch(t){console.log(t)}})}else e.each(a,function(e,n){if(t.indexOf(r,e)>-1&&n===!1||-1===t.indexOf(r,e))try{i.couponsData[e]=!1;i.model.apiRemoveCoupon(e).then(function(){})}catch(a){console.log(a)}})}else{var l=Object.keys(a),c=t.difference(r,l);c.forEach(function(e){try{i.couponsData[e]=!1;i.model.apiRemoveCoupon(e).then(function(){})}catch(t){console.log(t)}})}e.cookie("coupon",JSON.stringify(i.couponsData),{path:"/",expires:7})},onEnterCouponCode:function(e,t){t&&!this.codeEntered&&(this.codeEntered=!0,this.$el.find("button").prop("disabled",!1)),!t&&this.codeEntered&&(this.codeEntered=!1,this.$el.find("button").prop("disabled",!0))},autoUpdate:["couponCode"],setCookieCoupon:function(t,i){var n=this,a=e.cookie("coupon");a&&""!==a&&(n.couponsData=JSON.parse(a)),n.couponsData[t]=i,e.cookie("coupon",JSON.stringify(n.couponsData),{path:"/",expires:7})},addCoupon:function(){var n=this,a=this,r="",o="",s="",d=e("#coupon-code").val().toLowerCase(),l=n.model.get("couponCodes");l.indexOf(d.toLowerCase())<0&&this.setCookieCoupon(d,!1);var c=this.$el.find("#coupon-code").val().toLowerCase().trim();this.$el.addClass("is-loading"),i.getThemeSetting("couponCodeMultiple")||(e(n.model.apiModel.data.items).each(function(e,i){var n=t.pluck(i.productDiscounts,"couponCode");i.productDiscounts.length>0&&n.length>0&&void 0!==n[0]&&(r=!0)}),n.model.get("orderDiscounts").length>0&&e(n.model.get("orderDiscounts")).each(function(e,t){o=null!==t.couponCode&&void 0!==t.couponCode?!1:!0}),n.model.get("shippingDiscounts").length>0?e(n.model.get("shippingDiscounts")).each(function(e,t){s=null!==t.discount.couponCode&&void 0!==t.discount.couponCode?!1:!0}):s=!0,(o===!1||r||s===!1)&&(n.model.unset("couponCode"),setTimeout(function(){e("div.mz-messagebar:eq(0)").html('<ul class="is-showing mz-errors"><li class="mz-error-item">Sorry, only one promo code per order.</li></ul>')},1e3),e("html, body").animate({scrollTop:e("div.mz-messagebar:eq(0)").offset().top-100},300)));{var p="";require("hyprlivecontext").locals.themeSettings}if(y.user.isAuthenticated){var h=require.mozuData("customer").customer.attributes;e.each(h,function(e){"tenant~customertype"===h[e].fullyQualifiedName&&"MLT"===h[e].values[0]&&(p=h[e].values[0])})}if("smtpd"===c&&"MLT"===p&&y.user.isAuthenticated||"smtpd"!==c)this.model.addCoupon().ensure(function(){a.$el.removeClass("is-loading"),a.setCookieCoupon(d,!0),setTimeout(function(){a.model.unset("couponCode"),a.render()},100)}),p="";else if(y.user.isAuthenticated&&""===p&&"smtpd"===c){var m=document.getElementById("myModal");e("span.close").click(function(){null!==document.getElementById("asset_verify")&&e("iframe#asset_verify").remove(),m.style.display="none",setTimeout(function(){a.$el.removeClass("is-loading"),a.model.unset("couponCode"),a.render()},500)}),e('input[name="servicetype"]').on("change",function(){"VETERAN"===e('input[name="servicetype"]:checked').val()?e("#discharge_div").show():e("#discharge_div").hide()}),window.onclick=function(t){t.target==m&&(null!==document.getElementById("asset_verify")&&e("iframe#asset_verify").remove(),m.style.display="none",setTimeout(function(){a.$el.removeClass("is-loading"),a.model.unset("couponCode"),a.render()},500))},e("#firstname,#lastname,#email,#birthdate,#separationdate").on("change keypress keyup",function(){""!==e(this).val()&&e(this).next().hide()}),e("#ref_verify_div #birthdate,#ref_verify_div #separationdate").attr("data-date-format","yyyy-dd-mm"),e("#ref_verify_div #birthdate,#ref_verify_div #separationdate").datetimepicker({weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,forceParse:0}),e("#ref_verify_div").css("display","table-cell"),m.style.display="block",e("#verify-military").click(function(t){e("#verify-military").addClass("is-loading");var n,r,o,s,d=["#firstname","#lastname","#email","#birthdate","#separationdate"],l=/(?:19|20|21)[0-9]{2}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-9])|(?:(?!02)(?:0[1-9]|1[0-2])-(?:30))|(?:(?:0[13578]|1[02])-31))/g,c=/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3}$/g;e(d).each(function(t,i){""===e(i).val()?e(i).next().show():(e(i).next().hide(),n=!0),2===t&&c.test(e(i).val())?r=!0:2!==t||c.test(e(i).val())||(n=!1,e(i).next().show()),3===t&&l.test(e(i).val())?o=!0:3!==t||l.test(e(i).val())||(n=!1,e(i).next().text("Please Enter Valid Date").show()),4==t&&"none"!==e("#discharge_div").css("display")&&(l.test(e(i).val())?s=!0:(n=!1,e(i).next().show()))}),(r&&o||s&&"none"!==e("#discharge_div").css("display"))&&(n=!0);var p=i.getThemeSetting("sheerIDAuthUrl"),h="firstname="+e("#firstname").val()+"&lastname="+e("#lastname").val()+"&servicetype="+e('input[name="servicetype"]:checked').val()+"&email="+e("#email").val()+"&birthdate="+e("#birthdate").val()+"&separationdate="+e("#separationdate").val()+"&organizationId="+e("select#organizationId option:selected").text();n&&(e("<div></div>").addClass("page-loading").appendTo(document.body),e("#verify-military").attr("value","PLEASE WAIT"),e.ajax({type:"POST",url:p,dataType:"json",data:h,success:function(t){if(t.result===!0){var n={attributes:[{attributeDefinitionId:i.getThemeSetting("customerType"),fullyQualifiedName:"tenant~customertype",values:["MLT"]}],emailAddress:y.user.email,lastName:y.user.lastName,firstName:y.user.firstName};u.request("PUT","/api/commerce/customer/accounts/"+y.user.accountId,n).then(function(e){console.log(e)}),a.model.addCoupon(),e(".page-loading").remove(),e("#verify-military").attr("value","SUBMIT"),e("div#model-sheerid").html("Discount Applied. Thank YOU"),setTimeout(function(){a.model.unset("couponCode"),a.render()},2e3)}},error:function(t){var i=t.responseText;e("div#model-sheerid").append(i),e("div#model-sheerid").html(""),e("div#model-sheerid").css("display","none"),e(function(){e('<iframe id="asset_verify" style="background-color:#fefefe;margin:15%;padding:20px;border:1px solid #888;width:50%;font-family: MonstserratLight;"/>').appendTo("#res_sheerid"),e("iframe#asset_verify").contents().find("body").append("<h1>Unable to verify</h1><h3>Please upload supporting documentation</h3>"),e("iframe#asset_verify").contents().find("body").append(i),e(".page-loading").remove()});e("iframe#asset_verify").contents().find('input[name="success"]').val()}})),t.preventDefault()}),a.$el.removeClass("is-loading")}else"smtpd"!==c||y.user.isAuthenticated||(a.$el.removeClass("is-loading"),a.model.unset("couponCode"),a.render())},removeCoupon:function(t){var i=this,n=(this.$el,this.model.id,e(t.currentTarget).attr("name"));i.model.apiRemoveCoupon(n).then(function(){var t=e.cookie("coupon");t&&""!==t&&(i.couponsData=JSON.parse(t)),i.couponsData[n]=!1,e.cookie("coupon",JSON.stringify(i.couponsData),{path:"/",expires:7}),i.render()})},handleEnterKey:function(){this.addCoupon()}}),b=n.MozuView.extend({templateName:"modules/checkout/comments-field",autoUpdate:["shopperNotes.comments"]}),S=function(){var e=[],t=require.mozuData("pagecontext").storefrontOrderAttributes;return t&&t.length>0&&t.forEach(function(t){e.push("orderAttribute-"+t.attributeFQN)},this),console.log("fields"),console.log(e),e},A=n.MozuView.extend({templateName:"modules/checkout/step-review",autoUpdate:["createAccount","agreeToTerms","emailAddress","password","confirmPassword"].concat(S()),renderOnChange:["createAccount","isReady"],initialize:function(){var e=this;this.$el.on("keypress","input",function(t){return 13===t.which?(e.handleEnterKey(),!1):void 0}),this.model.on("passwordinvalid",function(t){e.$('[data-mz-validationmessage-for="password"]').text(t)}),this.model.on("userexists",function(t){e.$('[data-mz-validationmessage-for="emailAddress"]').html(i.getLabel("customerAlreadyExists",t,encodeURIComponent(window.location.pathname)))})},submit:function(){var e=this;try{var i=t.findWhere(this.model.toJSON().payments,{paymentType:"Check",status:"New"});void 0!==i&&e.model.set("orderAttribute-tenant~QOFLAG",!0)}catch(n){console.log(n)}t.defer(function(){e.model.submit(),window.sessionCamRecorder&&window.sessionCamRecorder.createVirtualPageLoad&&window.sessionCamRecorder.createVirtualPageLoad("/checkout/complete")})},handleEnterKey:function(){this.submit()}}),_=function(t){function n(){t.el.css("opacity",1),r&&r.remove()}var a=parseInt(i.getThemeSetting("gutterWidth"),10);isNaN(a)&&(a=15);var r;return t.model.on("beforerefresh",function(){n(),t.el.css("opacity",.5);var i=t.el.position();r=e("<div></div>",{"class":"mz-checkout-mask"}).css({width:t.el.outerWidth()+2*a,height:t.el.outerHeight()+2*a,top:i.top-a,left:i.left-a}).insertAfter(t.el)}),t.model.on("refresh",n),t.model.on("error",n),t};e(document).ready(function(){var n=e("#checkout-form"),s=require.mozuData("checkout");c.init(!0),s.isAmazonPayEnable=c.isEnabled;var d=window.order=new a.CheckoutPage(s),l={parentView:new _({el:n,model:d}),steps:{shippingAddress:new m({el:e("#step-shipping-address"),model:d.get("fulfillmentInfo").get("fulfillmentContact")}),shippingInfo:new g({el:e("#step-shipping-method"),model:d.get("fulfillmentInfo")}),paymentInfo:new C({el:e("#step-payment-info"),model:d.get("billingInfo")})},orderSummary:new h({el:e("#order-summary"),model:d}),couponCode:new w({el:e("#coupon-code-field"),model:d}),comments:i.getThemeSetting("showCheckoutCommentsField")&&new b({el:e("#comments-field"),model:d}),reviewPanel:new A({el:e("#step-review"),model:d}),messageView:r({el:n.find("[data-mz-message-bar]"),model:d.messages})};window.checkoutViews=l,d.on("complete",function(){o.setCount(0),window.amazon&&window.amazon.Login.logout(),window.location="/checkout/"+d.get("id")+"/confirmation"});var u=e("#step-review");d.on("change:isReady",function(e,t){t&&setTimeout(function(){window.scrollTo(0,u.offset().top)},750)}),t.invoke(l.steps,"initStepView"),n.noFlickerFadeIn(),c.isEnabled&&c.addCheckoutButton(window.order.id,!1),window.removePageLoader()}),window.zipArr=[],window.meltArr=[],e(document).on("click",".gift_input_toggle",function(){e(".giftcode_box").slideToggle(),e(".gift_input_toggle .fa").toggleClass("fa-minus")}),e(document).on("click",".summarybox_toggle",function(){e(".summary_box").slideToggle(),e(".checkout_coupan").slideToggle(),e(".summary_edit").slideToggle(),e(".summarybox_toggle .fa").toggleClass("fa-minus")}),e(document).on("click","#paypalexpress2",function(){e("#btn_xpressPaypal").trigger("click")}),e(document).on("click","#paywithamazon",function(){e("#OffAmazonPaymentsWidgets0").trigger("click")})}),define("pages/checkout",function(){});